{% extends "base.html" %}

{% block title %}My Profile - VesselOS{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-purple: #667eea;
        --secondary-purple: #764ba2;
        --accent-purple: #8b5cf6;
        --success-green: #10b981;
        --warning-orange: #f59e0b;
        --danger-red: #ef4444;
        --info-blue: #3b82f6;
    }
    
    .profile-section {
        background: linear-gradient(135deg, var(--primary-color, #5a4fcf) 0%, var(--secondary-color, #764ba2) 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 8px 24px rgba(var(--primary-rgb, 90, 79, 207), 0.2);
    }
    
    .profile-avatar {
        width: 150px;
        height: 150px;
        border: 4px solid white;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        object-fit: cover;
    }
    
    .document-card {
        transition: all 0.3s ease;
        border-left: 4px solid #007bff;
    }
    
    .document-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .file-size-badge {
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
    }
    
    .signature-preview {
        border: 2px dashed #dee2e6;
        padding: 1rem;
        text-align: center;
        min-height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        background: #f8f9fa;
    }
    
    .upload-area {
        border: 3px dashed #6c757d;
        border-radius: 10px;
        padding: 3rem 2rem;
        text-align: center;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .upload-area:hover {
        border-color: #007bff;
        background: #e7f3ff;
    }
    
    .upload-area.dragover {
        border-color: #28a745;
        background: #e8f5e9;
    }
    
    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
        position: relative;
        border-left: 5px solid transparent;
    }
    
    /* Colored accent bars for each stat card */
    .stat-card.stat-evaluations {
        border-left-color: var(--primary-purple, #667eea);
    }
    
    .stat-card.stat-avg-sqi {
        border-left-color: var(--info-blue, #3b82f6);
    }
    
    .stat-card.stat-documents {
        border-left-color: var(--success-green, #10b981);
    }
    
    .stat-card.stat-activity {
        border-left-color: var(--warning-orange, #f59e0b);
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, var(--primary-color, #5a4fcf) 0%, var(--secondary-color, #764ba2) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .activity-timeline {
        position: relative;
        padding-left: 2rem;
    }
    
    .activity-timeline::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, var(--primary-color, #5a4fcf), var(--secondary-color, #764ba2));
    }
    
    .activity-item {
        position: relative;
        padding-left: 2rem;
        margin-bottom: 2rem;
    }
    
    .activity-item::before {
        content: '';
        position: absolute;
        left: -8px;
        top: 0;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--primary-color, #5a4fcf);
        border: 3px solid white;
        box-shadow: 0 0 0 2px var(--primary-color, #5a4fcf);
    }
    
    .password-strength {
        height: 5px;
        border-radius: 3px;
        margin-top: 5px;
        background: #e9ecef;
        overflow: hidden;
    }
    
    .password-strength-bar {
        height: 100%;
        width: 0%;
        transition: width 0.3s ease;
    }
    
    .strength-weak { background: #dc3545; }
    .strength-fair { background: #ffc107; }
    .strength-good { background: #17a2b8; }
    .strength-strong { background: #28a745; }
    
    .document-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .pdf-icon { color: #dc3545; }
    .doc-icon { color: #007bff; }
    .xls-icon { color: #28a745; }
    .img-icon { color: #6f42c1; }
    
    .profile-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--primary-purple) 0%, var(--secondary-purple) 100%);
        color: white;
        font-size: 3rem;
    }
    
    .preview-container {
        margin-top: 20px;
        text-align: center;
    }
    
    .preview-image {
        max-width: 200px;
        max-height: 200px;
        border-radius: 50%;
        border: 3px solid #007bff;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    /* Messaging System Styles */
    .message-priority-urgent {
        border-left: 4px solid #dc3545 !important;
        background-color: rgba(220, 53, 69, 0.05) !important;
    }
    
    .message-priority-high {
        border-left: 4px solid #ffc107 !important;
        background-color: rgba(255, 193, 7, 0.05) !important;
    }
    
    .message-priority-normal {
        border-left: 4px solid #0d6efd !important;
        background-color: rgba(13, 110, 253, 0.05) !important;
    }
    
    .message-priority-low {
        border-left: 4px solid #6c757d !important;
        background-color: rgba(108, 117, 125, 0.05) !important;
    }
    
    .message-unread {
        background-color: #f8f9fa !important;
        font-weight: 600 !important;
    }
    
    .recipient-field {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    
    .user-search-dropdown {
        position: absolute;
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        width: 100%;
        display: none;
    }
    
    .user-search-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
    }
    
    .user-search-item:hover {
        background-color: #f8f9fa;
    }
    
    .user-search-item:last-child {
        border-bottom: none;
    }
    
    /* Shimmer effect for profile tabs */
    #profileTabs .nav-link {
        position: relative;
        overflow: hidden;
    }
    
    #profileTabs .nav-link::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s ease;
        z-index: 0;
    }
    
    #profileTabs .nav-link:hover::before {
        left: 100%;
    }
    
    #profileTabs .nav-link > * {
        position: relative;
        z-index: 1;
    }
    
    .user-search-item .avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        margin-right: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .user-search-item .info {
        flex: 1;
    }
    
    .user-search-item .name {
        font-weight: 500;
    }
    
    .user-search-item .details {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    /* Multiple files upload styles */
    .file-list {
        margin-top: 10px;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .file-item {
        display: flex;
        align-items: center;
        padding: 8px;
        margin-bottom: 5px;
        background: #f8f9fa;
        border-radius: 4px;
        border-left: 3px solid #007bff;
    }
    
    .file-item .file-icon {
        margin-right: 10px;
        color: #6c757d;
    }
    
    .file-item .file-info {
        flex: 1;
        overflow: hidden;
    }
    
    .file-item .file-name {
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .file-item .file-size {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .file-item .file-remove {
        color: #dc3545;
        cursor: pointer;
        margin-left: 10px;
    }
    
    .multiple-files-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #dc3545;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.7rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Reply button styles */
    .reply-btn {
        transition: all 0.2s ease;
    }
    
    .reply-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .reply-form {
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Messaging card styling */
    .list-group-item-action:hover {
        background-color: var(--light-purple) !important;
        color: var(--primary-purple) !important;
        transform: translateX(3px);
        transition: all 0.2s ease;
    }
    
    .list-group-item-action i {
        transition: color 0.2s ease;
    }
    
    .list-group-item-action:hover i {
        color: var(--primary-purple) !important;
    }
    
    @media (max-width: 768px) {
        .profile-avatar {
            width: 120px;
            height: 120px;
        }
        
        .stat-value {
            font-size: 2rem;
        }
        
        .user-search-dropdown {
            max-height: 150px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Profile Header -->
        <div class="profile-section">
            <div class="row align-items-center">
                <div class="col-auto">
                    <div id="profileAvatarContainer">
                        {% if user.profile_pic %}
                        <img src="{{ url_for('serve_profile_pic', filename=user.profile_pic) }}" 
                             class="profile-avatar rounded-circle" alt="Profile Picture" id="currentProfilePic">
                        {% else %}
                        <div class="profile-avatar rounded-circle d-flex align-items-center justify-content-center" id="defaultProfilePic">
                            <div class="profile-placeholder rounded-circle">
                                <i class="fas fa-user"></i>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col">
                    <h1 class="mb-1" id="profileName">{{ user.first_name }} {{ user.last_name }}</h1>
                    <p class="lead mb-2" id="profileRank">{{ user.rank }}</p>
                    <div class="d-flex flex-wrap gap-2">
                        <span class="badge bg-{{ 'danger' if user.role == 'port_engineer' else 'warning' if user.role == 'harbour_master' else 'success' }} fs-6">
                            {{ user.role|replace('_', ' ')|title }}
                        </span>
                        <span class="badge bg-info fs-6" id="profileDepartment">
                            {{ user.department or 'No Department' }}
                        </span>
                        <span class="badge bg-secondary fs-6" id="profileLocation">
                            {{ user.location or 'No Location' }}
                        </span>
                        <span class="badge bg-{{ 'success' if user.is_approved else 'warning' }} fs-6">
                            {{ 'Approved' if user.is_approved else 'Pending Approval' }}
                        </span>
                    </div>
                </div>
                <div class="col-auto">
                    <button class="btn btn-light btn-lg" onclick="window.printProfile && window.printProfile()" id="printProfileBtn" style="background: white; color: var(--primary-purple); border: 2px solid var(--primary-purple);">
                        <i class="fas fa-print me-2"></i> Print Profile
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3 col-6 mb-3">
        <div class="stat-card stat-evaluations">
            <div class="stat-value" id="totalEvaluations">0</div>
            <div class="metric-label">Evaluations</div>
        </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
        <div class="stat-card stat-avg-sqi">
            <div class="stat-value" id="avgSQI">0</div>
            <div class="metric-label">Avg SQI</div>
        </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
        <div class="stat-card stat-documents">
            <div class="stat-value" id="documentsCount">{{ documents|length }}</div>
            <div class="metric-label">Documents</div>
        </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
        <div class="stat-card stat-activity">
            <div class="stat-value">{{ user_activity_days|default(0) }}d</div>
            <div class="metric-label">Activity Days</div>
        </div>
    </div>
</div>

<!-- Main Content Tabs -->
<div class="row">
    <div class="col-12">
        <ul class="nav nav-tabs" id="profileTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="personal-tab" data-bs-toggle="tab" data-bs-target="#personal" type="button">
                    <i class="fas fa-user me-2"></i> Personal Info
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button">
                    <i class="fas fa-folder me-2"></i> Documents
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button">
                    <i class="fas fa-shield-alt me-2"></i> Security
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button">
                    <i class="fas fa-history me-2"></i> Activity Log
                </button>
            </li>
            {% if user.role == 'quality_officer' %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="quality-dashboard-tab" data-bs-toggle="tab" data-bs-target="#quality-dashboard" type="button">
                    <i class="fas fa-clipboard-check me-2"></i> Quality Dashboard
                </button>
            </li>
            {% endif %}
        </ul>
        
        <div class="tab-content" id="profileTabsContent">
            <!-- Personal Information Tab -->
            <div class="tab-pane fade show active" id="personal" role="tabpanel">
                <div class="row">
                    <div class="col-lg-8">
                        <h4 class="mb-4"><i class="fas fa-id-card me-2"></i> Personal Information</h4>
                        
                        <form id="updateProfileForm" enctype="multipart/form-data">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">First Name *</label>
                                        <input type="text" class="form-control" name="first_name" 
                                               value="{{ user.first_name }}" required id="firstNameInput">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Last Name *</label>
                                        <input type="text" class="form-control" name="last_name" 
                                               value="{{ user.last_name }}" required id="lastNameInput">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Email Address *</label>
                                <input type="email" class="form-control" value="{{ user.email }}" readonly>
                                <small class="form-text text-muted">Email cannot be changed. Contact administrator for email change.</small>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Phone Number *</label>
                                        <input type="tel" class="form-control" name="phone" 
                                               value="{{ user.phone or '' }}" required id="phoneInput">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Rank/Position *</label>
                                        <input type="text" class="form-control" name="rank" 
                                               value="{{ user.rank }}" required id="rankInput">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Department</label>
                                        <input type="text" class="form-control" name="department" 
                                               value="{{ user.department or '' }}" id="departmentInput">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Location</label>
                                        <input type="text" class="form-control" name="location" 
                                               value="{{ user.location or '' }}" id="locationInput">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Profile Picture Upload -->
                            <div class="mb-4">
                                <label class="form-label">Profile Picture</label>
                                <div class="upload-area" id="profilePicUploadArea" onclick="document.getElementById('profilePicInput').click()">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <h5>Upload Profile Picture</h5>
                                    <p class="text-muted mb-2">Drag & drop or click to browse</p>
                                    <small class="text-muted">Max size: 15MB • Formats: JPG, PNG, GIF</small>
                                    <input type="file" id="profilePicInput" name="profile_pic" 
                                           accept="image/*" style="display: none;" onchange="previewProfilePic(this)">
                                </div>
                                <div class="preview-container" id="profilePicPreview" style="display: none;">
                                    <h6>Preview:</h6>
                                    <img id="previewImage" class="preview-image" alt="Preview">
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-sm btn-danger" onclick="window.removeProfilePic && window.removeProfilePic()">
                                            <i class="fas fa-trash me-1"></i> Remove
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Digital Signature -->
                            <div class="mb-4">
                                <label class="form-label">Digital Signature</label>
                                <div class="signature-preview" id="signaturePreview">
                                    {% if user.signature_path %}
                                    <img src="{{ url_for('serve_signature', filename=user.signature_path) }}" 
                                         class="img-fluid" style="max-height: 100px;" alt="Signature" id="currentSignatureImg">
                                    {% else %}
                                    <div class="text-center">
                                        <i class="fas fa-signature fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">No signature uploaded</p>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="window.showSignatureModal && window.showSignatureModal()">
                                            <i class="fas fa-upload me-1"></i> Upload Signature
                                        </button>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="reset" class="btn btn-outline-secondary" id="resetChangesBtn" onclick="window.resetFormChanges && window.resetFormChanges()">
                                    <i class="fas fa-undo me-2"></i> Reset Changes
                                </button>
                                <button type="submit" class="btn btn-primary" id="updateProfileBtn">
                                    <i class="fas fa-save me-2"></i> Update Profile
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="col-lg-4">
                        <!-- Account Information -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i> Account Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">User ID</label>
                                    <input type="text" class="form-control" value="{{ user.user_id }}" readonly>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Member Since</label>
                                    <input type="text" class="form-control" value="{{ user.created_at[:10] if user.created_at else 'N/A' }}" readonly>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Last Login</label>
                                    <input type="text" class="form-control" value="{{ user.last_login or 'Never' }}" readonly>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Last Activity</label>
                                    <input type="text" class="form-control" value="{{ user.last_activity or 'None' }}" readonly>
                                </div>
                                
                                {% if user.survey_end_date %}
                                <div class="alert alert-info">
                                    <i class="fas fa-calendar-check me-2"></i>
                                    <strong>Survey Period:</strong> Valid until {{ user.survey_end_date }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Messaging System -->
                        <div class="card mt-3 border-0 shadow-sm">
                            <div class="card-body p-0">
                                <div class="px-3 py-2 border-bottom" style="background: white;">
                                    <h6 class="mb-0" style="color: #1f2937; font-weight: 600;">
                                        <i class="fas fa-comments me-2" style="color: #1f2937;"></i> Messaging
                                    </h6>
                                </div>
                                <div class="list-group list-group-flush">
                                    <a href="#" class="list-group-item list-group-item-action border-0" onclick="window.showSendMessageModal && window.showSendMessageModal(); return false;" style="color: #1f2937; padding: 0.75rem 1rem;">
                                        <i class="fas fa-paper-plane me-2" style="color: #1f2937;"></i> Send Message/Notification
                                    </a>
                                    <a href="#" class="list-group-item list-group-item-action border-0" onclick="window.showInbox && window.showInbox(); return false;" style="color: #1f2937; padding: 0.75rem 1rem;">
                                        <i class="fas fa-inbox me-2" style="color: #1f2937;"></i> Inbox
                                        <span class="badge float-end" id="unreadCount" style="background: var(--primary-purple); display: none;">0</span>
                                    </a>
                                    <a href="#" class="list-group-item list-group-item-action border-0" onclick="window.showSentMessagesModal && window.showSentMessagesModal(); return false;" style="color: #1f2937; padding: 0.75rem 1rem;">
                                        <i class="fas fa-paper-plane me-2" style="color: #1f2937;"></i> Sent Messages
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Profile Actions - Matching Reference Design -->
                        <div class="card mt-3">
                            <div class="card-body">
                                <h6 class="mb-3"><i class="fas fa-list me-2" style="color: var(--primary-purple);"></i> Profile Actions</h6>
                                
                                <!-- Print Professional Profile Card -->
                                <div class="card mb-3 border-0 shadow-sm" style="border-left: 4px solid var(--primary-purple) !important;">
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="fas fa-print fa-2x me-3" style="color: var(--primary-purple);"></i>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-0">Print Professional Profile</h6>
                                                <small class="text-muted">Generate a beautiful, print-ready profile document</small>
                                </div>
                            </div>
                                        <button class="btn btn-sm w-100 mt-2" onclick="window.printProfile && window.printProfile()" style="background: var(--primary-purple); color: white; border: none;">
                                            <i class="fas fa-eye me-1"></i> Preview & Print
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Generate Profile Report Card -->
                                <div class="card mb-3 border-0 shadow-sm" style="border-left: 4px solid var(--success-green) !important;">
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="fas fa-file-pdf fa-2x me-3" style="color: var(--success-green);"></i>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-0">Generate Profile Report</h6>
                                                <small class="text-muted">Create a detailed PDF report of your profile</small>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm w-100 mt-2" onclick="window.generateProfileReport && window.generateProfileReport()" style="background: var(--success-green); color: white; border: none;">
                                            <i class="fas fa-download me-1"></i> Download PDF
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Export Personal Data Card -->
                                <div class="card mb-3 border-0 shadow-sm" style="border-left: 4px solid var(--info-blue) !important;">
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="fas fa-download fa-2x me-3" style="color: var(--info-blue);"></i>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-0">Export Personal Data</h6>
                                                <small class="text-muted">Download all your personal data in JSON format</small>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm w-100 mt-2" onclick="window.downloadPersonalData && window.downloadPersonalData()" style="background: var(--info-blue); color: white; border: none;">
                                            <i class="fas fa-file-export me-1"></i> Export Data
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Request Account Deletion Card -->
                                <div class="card border-0 shadow-sm" style="border-left: 4px solid var(--danger-red) !important;">
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="fas fa-user-slash fa-2x me-3" style="color: var(--danger-red);"></i>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-0">Request Account Deletion</h6>
                                                <small class="text-muted">Request permanent deletion of your account</small>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm w-100 mt-2" onclick="window.requestAccountDeletion && window.requestAccountDeletion()" style="background: var(--danger-red); color: white; border: none;">
                                            <i class="fas fa-trash me-1"></i> Request Deletion
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Documents Tab -->
            <div class="tab-pane fade" id="documents" role="tabpanel">
                <h4 class="mb-4"><i class="fas fa-folder me-2"></i> My Documents</h4>
                
                <!-- Document Upload Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-upload me-2"></i> Upload Document</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadDocumentForm" enctype="multipart/form-data">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Document Name</label>
                                        <input type="text" class="form-control" name="document_name" placeholder="Enter document name" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Document Type</label>
                                        <select class="form-select" name="document_type" required>
                                            <option value="">Select type</option>
                                            <option value="certificate">Certificate</option>
                                            <option value="license">License</option>
                                            <option value="contract">Contract</option>
                                            <option value="report">Report</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Document File</label>
                                <div class="upload-area" id="documentUploadArea" onclick="document.getElementById('documentInput').click()">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <h5>Drag & Drop or Click to Upload</h5>
                                    <p class="text-muted mb-2">Supports multiple files: PDF, DOC, DOCX, XLS, XLSX, CSV, JPG, PNG</p>
                                    <small class="text-muted">Max size per file: 100MB • Multiple files allowed</small>
                                    <input type="file" id="documentInput" name="documents" multiple style="display: none;" onchange="previewDocumentNames(this)">
                                </div>
                                <div id="documentFileList" class="file-list mt-2"></div>
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary" id="uploadDocumentBtn">
                                    <i class="fas fa-upload me-2"></i> Upload Document(s)
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Document List -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-files me-2"></i> My Documents ({{ documents|length }})</h5>
                        <div class="d-flex gap-2">
                            <select class="form-select form-select-sm" style="width: auto;" onchange="sortDocuments(this.value)">
                                <option value="">Sort by</option>
                                <option value="name">Name</option>
                                <option value="date">Date</option>
                                <option value="size">Size</option>
                            </select>
                            <button class="btn btn-sm btn-outline-secondary" onclick="downloadSelectedDocuments()">
                                <i class="fas fa-download me-1"></i> Download Selected
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteSelectedDocuments()">
                                <i class="fas fa-trash me-1"></i> Delete Selected
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if documents %}
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="selectAllDocuments" onchange="toggleSelectAllDocuments(this)">
                            <label class="form-check-label" for="selectAllDocuments">
                                Select All Documents
                            </label>
                        </div>
                        
                        <div class="row" id="documentsGrid">
                            {% for doc in documents %}
                            <div class="col-lg-4 col-md-6 mb-3">
                                <div class="card document-card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                {% set file_ext = doc.document_path.split('.')[-1].lower() if doc.document_path else '' %}
                                                {% if file_ext == 'pdf' %}
                                                    <i class="fas fa-file-pdf fa-2x pdf-icon"></i>
                                                {% elif file_ext in ['doc', 'docx'] %}
                                                    <i class="fas fa-file-word fa-2x doc-icon"></i>
                                                {% elif file_ext in ['xls', 'xlsx', 'csv'] %}
                                                    <i class="fas fa-file-excel fa-2x xls-icon"></i>
                                                {% elif file_ext in ['jpg', 'jpeg', 'png', 'gif'] %}
                                                    <i class="fas fa-file-image fa-2x img-icon"></i>
                                                {% else %}
                                                    <i class="fas fa-file fa-2x text-muted"></i>
                                                {% endif %}
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input document-checkbox" type="checkbox" 
                                                       data-doc-id="{{ doc.id }}" onchange="toggleDocumentSelection('{{ doc.id }}', this)">
                                            </div>
                                        </div>
                                        <h6 class="card-title text-truncate">{{ doc.document_name }}</h6>
                                        <p class="card-text small text-muted">
                                            <i class="fas fa-calendar me-1"></i> {{ doc.uploaded_at[:10] if doc.uploaded_at else 'Unknown' }}<br>
                                            <i class="fas fa-weight-hanging me-1"></i> 
                                            {% if doc.file_size %}
                                                {{ (doc.file_size / (1024*1024))|round(2) }} MB
                                            {% else %}
                                                Unknown size
                                            {% endif %}
                                        </p>
                                        <div class="btn-group btn-group-sm w-100">
                                            <button class="btn btn-outline-primary" onclick="previewDocument('{{ doc.id }}')">
                                                <i class="fas fa-eye me-1"></i> View
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="renameDocument('{{ doc.id }}', '{{ doc.document_name }}')">
                                                <i class="fas fa-edit me-1"></i> Rename
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="deleteDocument('{{ doc.id }}', '{{ doc.document_name }}')">
                                                <i class="fas fa-trash me-1"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-folder-open fa-4x text-muted mb-3"></i>
                            <h5 class="text-muted">No documents uploaded yet</h5>
                            <p class="text-muted">Upload your first document using the form above</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Security Tab -->
            <div class="tab-pane fade" id="security" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <h4 class="mb-4"><i class="fas fa-key me-2"></i> Change Password</h4>
                        
                        <form id="changePasswordForm">
                            <div class="mb-3">
                                <label class="form-label">Current Password *</label>
                                <input type="password" class="form-control" name="current_password" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">New Password *</label>
                                <input type="password" class="form-control" name="new_password" required 
                                       onkeyup="checkPasswordStrength(this.value)">
                                <div class="password-strength">
                                    <div class="password-strength-bar" id="passwordStrengthBar"></div>
                                </div>
                                <small class="form-text text-muted">Password must be at least 8 characters</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Confirm New Password *</label>
                                <input type="password" class="form-control" name="confirm_password" required>
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary" id="changePasswordBtn">
                                    <i class="fas fa-save me-2"></i> Change Password
                                </button>
                            </div>
                        </form>
                        
                        <hr class="my-4">
                        
                        <h5 class="mb-3"><i class="fas fa-bell me-2"></i> Notification Settings</h5>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="soundNotificationsToggle" checked>
                            <label class="form-check-label" for="soundNotificationsToggle">
                                Sound notifications
                                <small class="d-block text-muted">Play sound when new notifications arrive</small>
                            </label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="browserNotificationsToggle" checked>
                            <label class="form-check-label" for="browserNotificationsToggle">
                                Browser notifications
                                <small class="d-block text-muted">Show notifications even when browser tab is not active</small>
                            </label>
                        </div>
                        <div class="mb-3" id="notificationPermissionStatus">
                            <small class="text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Checking permission status...
                            </small>
                        </div>
                        <button class="btn btn-outline-success btn-sm me-2" id="testNotificationBtn">
                            <i class="fas fa-bell me-1"></i> Send Test Notification
                        </button>
                        <button class="btn btn-outline-info btn-sm" id="requestNotificationPermBtn" style="display: none;">
                            <i class="fas fa-check-circle me-1"></i> Enable Notifications
                        </button>
                        
                        <hr class="my-4">
                        
                        <h5 class="mb-3"><i class="fas fa-user-shield me-2"></i> Security Settings</h5>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="profileVisibility" checked>
                            <label class="form-check-label" for="profileVisibility">
                                Profile visible to others
                            </label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="activitySharing" checked>
                            <label class="form-check-label" for="activitySharing">
                                Share activity status
                            </label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                            <label class="form-check-label" for="emailNotifications">
                                Email notifications
                            </label>
                        </div>
                        <button class="btn btn-outline-primary" onclick="savePrivacySettings()">
                            <i class="fas fa-save me-2"></i> Save Privacy Settings
                        </button>
                    </div>
                    
                    <div class="col-lg-6">
                        <h4 class="mb-4"><i class="fas fa-shield-alt me-2"></i> Account Security</h4>
                        
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6><i class="fas fa-lock me-2"></i> Two-Factor Authentication</h6>
                                <p class="text-muted small">Add an extra layer of security to your account</p>
                                <div id="2faStatus" class="mb-2">
                                    <span class="badge bg-secondary">Checking status...</span>
                                </div>
                                <button class="btn btn-outline-success" id="enable2FABtn" onclick="enableTwoFactor()" style="display: none;">
                                    <i class="fas fa-qrcode me-2"></i> Enable 2FA
                                </button>
                                <button class="btn btn-outline-danger" id="disable2FABtn" onclick="disableTwoFactor()" style="display: none;">
                                    <i class="fas fa-ban me-2"></i> Disable 2FA
                                </button>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6><i class="fas fa-sign-out-alt me-2"></i> Active Sessions</h6>
                                <p class="text-muted small">Manage your logged-in sessions</p>
                                <button class="btn btn-outline-warning" onclick="logoutOtherSessions()">
                                    <i class="fas fa-door-closed me-2"></i> Logout Other Sessions
                                </button>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <h6><i class="fas fa-history me-2"></i> Activity Log</h6>
                                <p class="text-muted small">Download your account activity history</p>
                                <button class="btn btn-outline-info" onclick="exportActivityLog()">
                                    <i class="fas fa-download me-2"></i> Export Activity Log
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Activity Log Tab -->
            <div class="tab-pane fade" id="activity" role="tabpanel">
                <h4 class="mb-4"><i class="fas fa-history me-2"></i> Activity Log</h4>
                
                <!-- Filters -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Activity Type</label>
                                    <select class="form-select" id="activityTypeFilter">
                                        <option value="">All Activities</option>
                                        <option value="login">Login</option>
                                        <option value="logout">Logout</option>
                                        <option value="profile_update">Profile Update</option>
                                        <option value="document_upload">Document Upload</option>
                                        <option value="evaluation">Evaluation</option>
                                        <option value="message_sent">Message Sent</option>
                                        <option value="message_replied">Message Replied</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="activityStartDate">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="activityEndDate">
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="filterActivities()">
                            <i class="fas fa-filter me-2"></i> Filter Activities
                        </button>
                    </div>
                </div>
                
                <!-- Activity Table -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i> Recent Activities</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadMoreActivities()">
                            <i class="fas fa-sync me-1"></i> Load More
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Activity</th>
                                        <th>Details</th>
                                        <th>IP Address</th>
                                    </tr>
                                </thead>
                                <tbody id="activityTable">
                                    <tr>
                                        <td colspan="4" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="mt-2 mb-0">Loading activities...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            {% if user.role == 'quality_officer' %}
            <!-- DMPO HQ Dashboard Tab -->
            <div class="tab-pane fade" id="quality-dashboard" role="tabpanel">
                <div class="mb-4">
                    <h4 class="mb-3"><i class="fas fa-clipboard-check me-2" style="color: var(--success-green);"></i> DMPO HQ Dashboard</h4>
                    <p class="text-muted">Conduct service quality evaluations and monitor performance metrics</p>
                </div>
                
                <!-- DMPO HQ Stats -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card stat-card stat-evaluations h-100">
                            <div class="card-body text-center">
                                <div class="stat-value" id="qo-myEvaluations">--</div>
                                <div class="mb-2" style="font-weight: 600; color: #495057;">My Evaluations</div>
                                <small class="text-muted">Total evaluations conducted</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card stat-card stat-avg-sqi h-100">
                            <div class="card-body text-center">
                                <div class="stat-value" id="qo-avgSqi">--</div>
                                <div class="mb-2" style="font-weight: 600; color: #495057;">Avg SQI</div>
                                <small class="text-muted">Average Service Quality</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card stat-card stat-activity h-100">
                            <div class="card-body text-center">
                                <div class="stat-value" id="qo-daysRemaining">--</div>
                                <div class="mb-2" style="font-weight: 600; color: #495057;">Days Remaining</div>
                                <small class="text-muted">Survey access period</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card h-100" style="border-left: 4px solid var(--warning-orange);">
                            <div class="card-body text-center d-flex flex-column justify-content-center">
                                <button class="btn btn-warning w-100 py-3" onclick="showQOAccessRequestModal()" style="border: none;">
                                    <i class="fas fa-clock-history me-2"></i> Request Access Extension
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Role Interactions -->
                <div class="row mb-4" id="qo-roleInteractionsSection">
                    <div class="col-12">
                        <div class="card border-info shadow-sm">
                            <div class="card-header bg-info text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-bell me-2"></i> Important Notices & Actions</h5>
                                    <span class="badge bg-warning" id="qo-actionCount">0</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row" id="qo-roleInteractions">
                                    <div class="col-12 text-center py-3">
                                        <div class="spinner-border text-info" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Checking for notices...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Left Column -->
                    <div class="col-lg-4">
                        <!-- Quick Actions -->
                        <div class="card mb-3 shadow-sm">
                            <div class="card-header bg-white">
                                <h5 class="mb-0"><i class="fas fa-bolt me-2" style="color: var(--primary-purple);"></i> Quick Actions</h5>
                            </div>
                            <div class="card-body">
                                <a href="{{ url_for('evaluate') }}" class="btn btn-primary w-100 mb-3 d-flex align-items-center justify-content-center">
                                    <i class="fas fa-plus-circle me-2"></i>
                                    <span>New Service Evaluation</span>
                                </a>
                                <a href="{{ url_for('monitor') }}" class="btn btn-info w-100 mb-3 d-flex align-items-center justify-content-center">
                                    <i class="fas fa-chart-line me-2"></i>
                                    <span>View Performance</span>
                                </a>
                                <button class="btn btn-warning w-100 d-flex align-items-center justify-content-center" onclick="showQOAccessRequestModal()">
                                    <i class="fas fa-clock me-2"></i>
                                    <span>Request Access Extension</span>
                                </button>
                                
                                <hr class="my-3">
                                
                                <!-- Daily Target -->
                                <div class="mt-3">
                                    <h6><i class="fas fa-bullseye me-2" style="color: var(--success-green);"></i> Daily Target</h6>
                                    <div class="progress mb-2" style="height: 20px; border-radius: 10px;">
                                        <div class="progress-bar bg-success" id="qo-dailyProgress" style="width: 0%; border-radius: 10px;"></div>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <small class="text-muted">Evaluations Today</small>
                                        <small><strong><span id="qo-todayCount">0</span>/5</strong></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Survey Status -->
                        <div class="card shadow-sm">
                            <div class="card-header bg-white">
                                <h5 class="mb-0"><i class="fas fa-calendar-check me-2" style="color: var(--info-blue);"></i> Survey Status</h5>
                            </div>
                            <div class="card-body">
                                <div id="qo-surveyStatus">
                                    <div class="text-center py-2">
                                        <div class="spinner-border spinner-border-sm text-success" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <small class="text-muted ms-2">Loading survey status...</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column -->
                    <div class="col-lg-8">
                        <!-- Recent Evaluations -->
                        <div class="card mb-3 shadow-sm">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-history me-2" style="color: var(--primary-purple);"></i> My Recent Evaluations</h5>
                                <div>
                                    <a href="{{ url_for('evaluate') }}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-plus me-1"></i> New
                                    </a>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="loadQOMyevaluations()">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Vessel</th>
                                                <th>SQI</th>
                                                <th>Rating</th>
                                                <th>Priority</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="qo-myEvaluationsTable">
                                            <tr>
                                                <td colspan="6" class="text-center py-4">
                                                    <div class="spinner-border text-success" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <p class="mt-2 text-muted">Loading recent evaluations...</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Performance Chart -->
                        <div class="card mb-3 shadow-sm">
                            <div class="card-header bg-white">
                                <h5 class="mb-0"><i class="fas fa-chart-line me-2" style="color: var(--info-blue);"></i> SQI Trend (Last 7 Evaluations)</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                                    <canvas id="qo-sqiChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Evaluation Tips -->
                        <div class="card shadow-sm">
                            <div class="card-header bg-white">
                                <h5 class="mb-0"><i class="fas fa-lightbulb me-2" style="color: var(--warning-orange);"></i> Evaluation Guidelines</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="alert alert-success mb-0">
                                            <h6><i class="fas fa-check-circle me-2"></i> Best Practices</h6>
                                            <ul class="mb-0 small">
                                                <li>Document all service parameters accurately</li>
                                                <li>Take photos of critical components</li>
                                                <li>Note any safety concerns immediately</li>
                                                <li>Verify parts availability before evaluation</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="alert alert-info mb-0">
                                            <h6><i class="fas fa-info-circle me-2"></i> Reminders</h6>
                                            <ul class="mb-0 small">
                                                <li>Complete at least 5 evaluations daily</li>
                                                <li>Report emergencies within 15 minutes</li>
                                                <li>Update incomplete evaluations within 24 hours</li>
                                                <li>Maintain survey period compliance</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Signature Modal -->
<div class="modal fade" id="signatureModal" tabindex="-1" aria-labelledby="signatureModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="signatureModalLabel">
                    <i class="fas fa-signature me-2"></i>Digital Signature
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Current Signature Preview -->
                <div class="mb-4">
                    <h6>Current Signature:</h6>
                    <div class="signature-preview mb-3" id="modalSignaturePreview">
                        {% if user.signature_path %}
                        <img src="{{ url_for('serve_signature', filename=user.signature_path) }}" 
                             class="img-fluid" style="max-height: 150px;" alt="Signature" id="currentSignatureImg">
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-signature fa-4x text-muted mb-3"></i>
                            <p class="text-muted">No signature uploaded</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if user.signature_path %}
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeSignature()">
                        <i class="fas fa-trash me-1"></i> Remove Current Signature
                    </button>
                    {% endif %}
                </div>
                
                <hr>
                
                <!-- Upload New Signature -->
                <div class="mb-3">
                    <h6>Upload New Signature:</h6>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>Upload a clear image of your signature. Recommended: PNG with transparent background. Max size: 5MB</small>
                    </div>
                    
                    <div class="upload-area" id="signatureUploadArea" onclick="document.getElementById('signatureInput').click()">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <h5>Drag & Drop or Click to Upload</h5>
                        <p class="text-muted mb-2">Supports JPG, PNG, GIF</p>
                        <small class="text-muted">Max size: 5MB</small>
                        <input type="file" id="signatureInput" accept="image/*" style="display: none;" onchange="previewSignature(this)">
                    </div>
                    
                    <!-- Preview -->
                    <div class="mt-3" id="signaturePreviewContainer" style="display: none;">
                        <h6>Preview:</h6>
                        <div class="signature-preview">
                            <img id="signaturePreviewImage" class="img-fluid" style="max-height: 150px;" alt="Signature Preview">
                        </div>
                    </div>
                </div>
                
                <!-- Canvas Signature (Optional - for drawing) -->
                <div class="mb-3">
                    <h6>Or Draw Signature:</h6>
                    <div class="card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <canvas id="signatureCanvas" width="400" height="200" 
                                            style="border: 1px solid #ddd; cursor: crosshair;"></canvas>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="clearCanvas()">
                                            <i class="fas fa-eraser me-1"></i> Clear
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="undoCanvas()">
                                            <i class="fas fa-undo me-1"></i> Undo
                                        </button>
                                        <button type="button" class="btn btn-sm btn-success" onclick="saveCanvasSignature()">
                                            <i class="fas fa-save me-1"></i> Use This Signature
                                        </button>
                                    </div>
                                    <div class="mt-2">
                                        <label>Pen Color:</label>
                                        <input type="color" id="penColor" value="#000000" class="form-control form-control-color">
                                    </div>
                                    <div class="mt-2">
                                        <label>Pen Size:</label>
                                        <input type="range" id="penSize" min="1" max="10" value="2" class="form-range">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="uploadSignatureBtn" onclick="uploadSignature()" disabled>
                    <i class="fas fa-upload me-1"></i> Upload Signature
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Document Preview Modal -->
<div class="modal fade" id="documentPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="documentPreviewTitle">Document Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="documentPreviewContent">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="downloadCurrentDocument()">
                    <i class="fas fa-download me-2"></i> Download
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Messaging System Modals -->

<!-- Send Message Modal -->
<div class="modal fade" id="sendMessageModal" tabindex="-1" aria-labelledby="sendMessageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sendMessageModalLabel">
                    <i class="fas fa-paper-plane me-2"></i>Send Message/Notification
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="sendMessageForm" enctype="multipart/form-data">
                    <!-- Message Type -->
                    <div class="mb-3">
                        <label class="form-label">Message Type *</label>
                        <select class="form-select" id="messageType" name="message_type" required onchange="toggleReplyOption()">
                            <option value="message">Message (allows replies)</option>
                            <option value="notification">Notification</option>
                            <option value="announcement">Announcement</option>
                        </select>
                    </div>
                    
                    <!-- Recipient Type -->
                    <div class="mb-3">
                        <label class="form-label">Send To *</label>
                        <select class="form-select" id="recipientType" name="recipient_type" required onchange="toggleRecipientFields()">
                            <option value="specific_user">Specific User</option>
                            <option value="role">Specific Role</option>
                            <option value="department">Specific Department</option>
                            <option value="all">All Users</option>
                        </select>
                    </div>
                    
                    <!-- Recipient Identification Fields -->
                    <div id="recipientFields">
                        <!-- Specific User Fields with Search -->
                        <div class="recipient-field" id="userField">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label class="form-label">Search User</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="userSearch" 
                                                   placeholder="Search by name, email, or ID" 
                                                   onkeyup="searchUsers(this.value)">
                                            <button class="btn btn-outline-secondary" type="button" onclick="searchUsers(document.getElementById('userSearch').value)">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                        <div class="user-search-dropdown" id="userSearchResults"></div>
                                        <small class="form-text text-muted">Type to search for users. You can also manually enter details below.</small>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">User ID</label>
                                        <input type="text" class="form-control" id="userId" name="user_id" placeholder="Enter User ID">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" id="userEmail" name="user_email" placeholder="Enter Email">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Phone</label>
                                        <input type="tel" class="form-control" id="userPhone" name="user_phone" placeholder="Enter Phone">
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <small>Fill in at least one field above OR use the search to select a user. If you use search, the fields will be auto-filled.</small>
                            </div>
                        </div>
                        
                        <!-- Role Field -->
                        <div class="recipient-field" id="roleField" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Select Role</label>
                                <select class="form-select" id="roleSelect" name="role">
                                    <option value="">Select Role</option>
                                    <option value="chief_engineer">Chief Engineer</option>
                                    <option value="captain">Captain</option>
                                    <option value="port_engineer">Port Engineer</option>
                                    <option value="harbour_master">Harbour Master</option>
                                    <option value="quality_officer">DMPO HQ</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Department Field -->
                        <div class="recipient-field" id="departmentField" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Select Department</label>
                                <select class="form-select" id="departmentSelect" name="department">
                                    <option value="">Select Department</option>
                                    <option value="Management">Management</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Quality Assurance">Quality Assurance</option>
                                    <option value="Operations">Operations</option>
                                    <option value="Logistics">Logistics</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Title -->
                    <div class="mb-3">
                        <label class="form-label">Title *</label>
                        <input type="text" class="form-control" id="messageTitle" name="title" required placeholder="Enter message title">
                    </div>
                    
                    <!-- Message -->
                    <div class="mb-3">
                        <label class="form-label">Message *</label>
                        <textarea class="form-control" id="messageText" name="message" rows="4" required placeholder="Enter your message"></textarea>
                    </div>
                    
                    <!-- Priority -->
                    <div class="mb-3">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="messagePriority" name="priority">
                            <option value="low">Low</option>
                            <option value="normal" selected>Normal</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    
                    <!-- Attachment - MULTIPLE FILES -->
                    <div class="mb-3">
                        <label class="form-label">Attachments (Optional)</label>
                        <div class="upload-area" id="messageAttachmentArea" onclick="document.getElementById('messageAttachment').click()">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h5>Click to attach files</h5>
                            <p class="text-muted mb-2">Max size per file: 20MB • Multiple files allowed</p>
                            <small class="text-muted">Supports: PDF, DOC, XLS, JPG, PNG, GIF, ZIP</small>
                            <div class="position-relative d-inline-block">
                                <input type="file" id="messageAttachment" name="attachments" multiple style="display: none;" onchange="previewAttachments(this)">
                                <span class="multiple-files-badge" id="fileCountBadge" style="display: none;">0</span>
                            </div>
                        </div>
                        <div id="attachmentList" class="file-list mt-2"></div>
                    </div>
                    
                    <!-- Allow Replies (only for messages) -->
                    <div class="mb-3" id="allowRepliesDiv">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="allowReplies" name="allow_replies" checked value="true">
                            <label class="form-check-label" for="allowReplies">
                                Allow recipients to reply to this message
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendMessageBtn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane me-1"></i> Send
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Inbox Modal -->
<div class="modal fade" id="inboxModal" tabindex="-1" aria-labelledby="inboxModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inboxModalLabel">
                    <i class="fas fa-inbox me-2"></i>Inbox
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex mb-3">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary active" onclick="filterInbox('all')">All</button>
                        <button type="button" class="btn btn-outline-primary" onclick="filterInbox('unread')">Unread</button>
                        <button type="button" class="btn btn-outline-primary" onclick="filterInbox('messages')">Messages</button>
                        <button type="button" class="btn btn-outline-primary" onclick="filterInbox('notifications')">Notifications</button>
                        <button type="button" class="btn btn-outline-primary" onclick="filterInbox('announcements')">Announcements</button>
                    </div>
                    <button class="btn btn-outline-danger ms-auto" onclick="markAllAsRead()">
                        <i class="fas fa-check-double me-1"></i> Mark All as Read
                    </button>
                </div>
                
                <div id="inboxContent">
                    <!-- Messages will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Message Detail Modal -->
<div class="modal fade" id="messageDetailModal" tabindex="-1" aria-labelledby="messageDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="messageDetailModalLabel">
                    <i class="fas fa-envelope me-2"></i>Message Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="messageDetailContent">
                    <!-- Message details will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sent Messages Modal -->
<div class="modal fade" id="sentMessagesModal" tabindex="-1" aria-labelledby="sentMessagesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sentMessagesModalLabel">
                    <i class="fas fa-paper-plane me-2"></i> Sent Messages
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Filter controls -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <select class="form-select" id="sentFilterType">
                            <option value="all">All Types</option>
                            <option value="message">Messages</option>
                            <option value="notification">Notifications</option>
                            <option value="announcement">Announcements</option>
                        </select>
                    </div>
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="sentSearch" 
                               placeholder="Search in sent messages...">
                    </div>
                </div>
                
                <!-- Sent messages list -->
                <div id="sentMessagesList">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading sent messages...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Two-Factor Authentication Setup Modal -->
<div class="modal fade" id="twoFactorModal" tabindex="-1" aria-labelledby="twoFactorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="twoFactorModalLabel">
                    <i class="fas fa-shield-alt me-2"></i> Two-Factor Authentication Setup
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="2faSetupStep1">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Step 1:</strong> Scan the QR code below with your authenticator app (Google Authenticator, Authy, etc.)
                    </div>
                    <div class="text-center mb-4">
                        <div id="qrCodeContainer" class="mb-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading QR code...</span>
                            </div>
                        </div>
                        <div class="alert alert-light">
                            <strong>Manual Entry Code:</strong><br>
                            <code id="manualEntryCode" class="fs-5"></code>
                        </div>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Important:</strong> Save this code in a safe place. You'll need it if you lose access to your authenticator app.
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Step 2:</strong> Enter the 6-digit code from your authenticator app</label>
                        <input type="text" class="form-control text-center fs-4" id="2faVerificationCode" 
                               placeholder="000000" maxlength="6" pattern="[0-9]{6}">
                        <small class="form-text text-muted">Enter the code shown in your authenticator app to verify setup</small>
                    </div>
                    <div class="d-grid">
                        <button type="button" class="btn btn-success" onclick="verifyAndEnable2FA()">
                            <i class="fas fa-check me-2"></i> Verify and Enable 2FA
                        </button>
                    </div>
                </div>
                <div id="2faDisableStep" style="display: none;">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> Disabling 2FA will reduce your account security. Are you sure?
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Enter your 6-digit 2FA code to confirm</label>
                        <input type="text" class="form-control text-center fs-4" id="2faDisableCode" 
                               placeholder="000000" maxlength="6" pattern="[0-9]{6}">
                    </div>
                    <div class="d-grid">
                        <button type="button" class="btn btn-danger" onclick="confirmDisable2FA()">
                            <i class="fas fa-ban me-2"></i> Disable 2FA
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if user.role == 'quality_officer' %}
<!-- DMPO HQ Access Request Modal -->
<div class="modal fade" id="qoAccessRequestModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-clock-history me-2"></i> Request Access Extension
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Your request will be sent to the port engineer for approval.
                </div>
                
                <form id="qoAccessRequestForm">
                    <div class="mb-3">
                        <label class="form-label">Additional Days Required *</label>
                        <input type="number" class="form-control" id="qoAdditionalDays" min="1" max="90" value="30" required>
                        <small class="form-text text-muted">Maximum extension: 90 days</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Reason for Extension *</label>
                        <textarea class="form-control" id="qoExtensionReason" rows="3" 
                                  placeholder="Explain why you need additional access time..." required></textarea>
                        <small class="form-text text-muted">Provide specific reasons such as ongoing projects or additional surveys needed.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Expected Completion Date *</label>
                        <input type="date" class="form-control" id="qoExpectedCompletion" required>
                        <small class="form-text text-muted">When do you expect to complete your surveys?</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Supporting Documents</label>
                        <input type="file" class="form-control" id="qoSupportingDocs" multiple 
                               accept=".pdf,.doc,.docx,.jpg,.png">
                        <small class="form-text text-muted">Upload any supporting documents (max 100MB total)</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="submitQOAccessRequest()">
                    <i class="fas fa-paper-plane me-1"></i> Submit Request
                </button>
            </div>
        </div>
    </div>
</div>

<!-- DMPO HQ Evaluation Details Modal -->
<div class="modal fade" id="qoEvaluationDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-clipboard-check me-2"></i> Evaluation Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="qoEvaluationDetailsContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// ==================== FIXED PROFILE FUNCTIONS ====================

// Store original form values for reset functionality
let originalFormValues = {};
let selectedDocuments = new Set();

// Signature Canvas Variables
let signatureCanvas = null;
let signatureCtx = null;
let canvasPaths = [];
let currentPath = [];
let isDrawing = false;

// Initialize profile data
document.addEventListener('DOMContentLoaded', function() {
    loadProfileStats();
    loadActivityData();
    setupDragAndDrop();
    initMessaging();
    initCanvas();
    load2FAStatus();
    
    // Store original form values
    saveOriginalFormValues();
    
    // Initialize event listeners for messaging
    initMessageEventListeners();
    
    // Set up recipient type toggle
    const recipientTypeSelect = document.getElementById('recipientType');
    if (recipientTypeSelect) {
        recipientTypeSelect.addEventListener('change', toggleRecipientFields);
        toggleRecipientFields(); // Initialize on load
    }
    
    // Set up message type toggle
    const messageTypeSelect = document.getElementById('messageType');
    if (messageTypeSelect) {
        messageTypeSelect.addEventListener('change', toggleReplyOption);
        toggleReplyOption(); // Initialize on load
    }
    
    // Set up inbox modal event listener
    const inboxModal = document.getElementById('inboxModal');
    if (inboxModal) {
        inboxModal.addEventListener('shown.bs.modal', function() {
            loadInboxMessages('all');
        });
    }
    
    // Set up event listeners for sent messages modal
    const sentFilterType = document.getElementById('sentFilterType');
    const sentSearch = document.getElementById('sentSearch');
    
    if (sentFilterType) {
        sentFilterType.addEventListener('change', function() {
            loadSentMessages(this.value, document.getElementById('sentSearch').value);
        });
    }
    
    if (sentSearch) {
        sentSearch.addEventListener('keyup', function() {
            loadSentMessages(document.getElementById('sentFilterType').value, this.value);
        });
    }
    
    // When sent messages modal is shown
    const sentModal = document.getElementById('sentMessagesModal');
    if (sentModal) {
        sentModal.addEventListener('shown.bs.modal', function() {
            loadSentMessages();
        });
    }
    
    // Initialize signature canvas when modal is shown
    const signatureModal = document.getElementById('signatureModal');
    if (signatureModal) {
        signatureModal.addEventListener('shown.bs.modal', function() {
            setTimeout(() => {
                initSignatureCanvas();
                
                // Update pen settings
                const penColor = document.getElementById('penColor');
                const penSize = document.getElementById('penSize');
                
                if (penColor && signatureCtx) {
                    penColor.addEventListener('input', function() {
                        signatureCtx.strokeStyle = this.value;
                    });
                }
                
                if (penSize && signatureCtx) {
                    penSize.addEventListener('input', function() {
                        signatureCtx.lineWidth = this.value;
                    });
                }
            }, 100);
        });
    }
});

// Profile statistics
function loadProfileStats() {
    fetch('/api/profile/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const totalEval = document.getElementById('totalEvaluations');
                const avgSQI = document.getElementById('avgSQI');
                
                if (totalEval) totalEval.textContent = data.stats.total_evaluations || 0;
                if (avgSQI) avgSQI.textContent = data.stats.avg_sqi || 0;
            }
        })
        .catch(error => console.error('Error loading profile stats:', error));
}

// Save original form values for reset functionality
function saveOriginalFormValues() {
    const firstNameInput = document.getElementById('firstNameInput');
    const lastNameInput = document.getElementById('lastNameInput');
    const phoneInput = document.getElementById('phoneInput');
    const rankInput = document.getElementById('rankInput');
    const departmentInput = document.getElementById('departmentInput');
    const locationInput = document.getElementById('locationInput');
    
    if (firstNameInput && lastNameInput && phoneInput && rankInput && departmentInput && locationInput) {
        originalFormValues = {
            firstName: firstNameInput.value,
            lastName: lastNameInput.value,
            phone: phoneInput.value,
            rank: rankInput.value,
            department: departmentInput.value,
            location: locationInput.value
        };
    }
}

// Reset form changes
function resetFormChanges() {
    // Reset form inputs
    const firstNameInput = document.getElementById('firstNameInput');
    const lastNameInput = document.getElementById('lastNameInput');
    const phoneInput = document.getElementById('phoneInput');
    const rankInput = document.getElementById('rankInput');
    const departmentInput = document.getElementById('departmentInput');
    const locationInput = document.getElementById('locationInput');
    
    if (firstNameInput) firstNameInput.value = originalFormValues.firstName;
    if (lastNameInput) lastNameInput.value = originalFormValues.lastName;
    if (phoneInput) phoneInput.value = originalFormValues.phone;
    if (rankInput) rankInput.value = originalFormValues.rank;
    if (departmentInput) departmentInput.value = originalFormValues.department;
    if (locationInput) locationInput.value = originalFormValues.location;
    
    // Clear profile picture preview
    const profilePicPreview = document.getElementById('profilePicPreview');
    const profilePicInput = document.getElementById('profilePicInput');
    
    if (profilePicPreview) profilePicPreview.style.display = 'none';
    if (profilePicInput) profilePicInput.value = '';
    
    // Update header display
    const profileName = document.getElementById('profileName');
    const profileRank = document.getElementById('profileRank');
    const profileDepartment = document.getElementById('profileDepartment');
    const profileLocation = document.getElementById('profileLocation');
    
    if (profileName) profileName.textContent = originalFormValues.firstName + ' ' + originalFormValues.lastName;
    if (profileRank) profileRank.textContent = originalFormValues.rank;
    if (profileDepartment) profileDepartment.textContent = originalFormValues.department || 'No Department';
    if (profileLocation) profileLocation.textContent = originalFormValues.location || 'No Location';
    
    showAlert('info', 'Form has been reset to original values');
}

// ==================== FIXED PROFILE PICTURE UPLOAD ====================

// Update profile form
const updateProfileForm = document.getElementById('updateProfileForm');
if (updateProfileForm) {
    updateProfileForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        // Check if a new profile picture was selected
        const profilePicInput = document.getElementById('profilePicInput');
        if (profilePicInput && profilePicInput.files.length > 0) {
            const file = profilePicInput.files[0];
            
            // Validate file type
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            if (!validTypes.includes(file.type.toLowerCase())) {
                showAlert('danger', 'Invalid file type. Please upload JPG, PNG, or GIF');
                return;
            }
            
            // Validate file size (15MB limit)
            if (file.size > 15 * 1024 * 1024) {
                showAlert('danger', 'File size exceeds 15MB limit');
                return;
            }
        }
        
        // Show loading state
        const submitBtn = document.getElementById('updateProfileBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
        submitBtn.disabled = true;
        
        fetch('/api/update-profile', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showAlert('success', 'Profile updated successfully!');
                
                // Update header display
                const firstName = document.getElementById('firstNameInput').value;
                const lastName = document.getElementById('lastNameInput').value;
                const rank = document.getElementById('rankInput').value;
                const department = document.getElementById('departmentInput').value;
                const location = document.getElementById('locationInput').value;
                
                const profileName = document.getElementById('profileName');
                const profileRank = document.getElementById('profileRank');
                const profileDepartment = document.getElementById('profileDepartment');
                const profileLocation = document.getElementById('profileLocation');
                
                if (profileName) profileName.textContent = firstName + ' ' + lastName;
                if (profileRank) profileRank.textContent = rank;
                if (profileDepartment) profileDepartment.textContent = department || 'No Department';
                if (profileLocation) profileLocation.textContent = location || 'No Location';
                
                // Update original values
                saveOriginalFormValues();
                
                // Handle profile picture preview
                if (profilePicInput && profilePicInput.files.length > 0) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // Update the profile picture in the header with server URL for persistence
                        const profilePicContainer = document.getElementById('profileAvatarContainer');
                        if (profilePicContainer) {
                            // Use server URL if provided, add timestamp to bypass cache
                            const imageUrl = data.profile_pic_url 
                                ? (data.profile_pic_url + '?t=' + Date.now())
                                : e.target.result;
                            profilePicContainer.innerHTML = `
                                <img src="${imageUrl}" class="profile-avatar rounded-circle" alt="Profile Picture" id="currentProfilePic" onerror="this.src='${e.target.result}'">
                            `;
                        }
                        
                        // Clear the preview
                        const profilePicPreview = document.getElementById('profilePicPreview');
                        if (profilePicPreview) profilePicPreview.style.display = 'none';
                        profilePicInput.value = '';
                        
                        // Also update the navbar profile picture
                        const navProfilePic = document.querySelector('#userDropdown img');
                        if (navProfilePic) {
                            const navImageUrl = data.profile_pic_url
                                ? (data.profile_pic_url + '?t=' + Date.now())
                                : e.target.result;
                            navProfilePic.src = navImageUrl;
                        }
                    };
                    reader.readAsDataURL(profilePicInput.files[0]);
                }
                
                // Refresh profile stats immediately after upload
                loadProfileStats();
            } else {
                showAlert('danger', 'Error: ' + (data.error || 'Update failed'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', 'Error updating profile: ' + error.message);
        })
        .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            // IMPORTANT: Do NOT reload page - the profile form needs to stay interactive
        });
    });
}

// Profile picture handling
function previewProfilePic(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Check file size (15MB limit)
        if (file.size > 15 * 1024 * 1024) {
            showAlert('danger', 'File size exceeds 15MB limit');
            input.value = '';
            return;
        }
        
        // Check file type
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        if (!validTypes.includes(file.type.toLowerCase())) {
            showAlert('danger', 'Invalid file type. Please upload JPG, PNG, or GIF');
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewImage = document.getElementById('previewImage');
            const profilePicPreview = document.getElementById('profilePicPreview');
            
            if (previewImage) previewImage.src = e.target.result;
            if (profilePicPreview) profilePicPreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
}

function removeProfilePic() {
    const profilePicInput = document.getElementById('profilePicInput');
    const profilePicPreview = document.getElementById('profilePicPreview');
    
    if (profilePicInput) profilePicInput.value = '';
    if (profilePicPreview) profilePicPreview.style.display = 'none';
}

// ==================== FIXED DOCUMENT UPLOAD ====================

// Document upload form
const uploadDocumentForm = document.getElementById('uploadDocumentForm');
if (uploadDocumentForm) {
    uploadDocumentForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const fileInput = document.getElementById('documentInput');
        
        if (!fileInput || fileInput.files.length === 0) {
            showAlert('warning', 'Please select at least one file to upload');
            return;
        }
        
        // Get document name and type
        const documentName = this.querySelector('[name="document_name"]').value;
        const documentType = this.querySelector('[name="document_type"]').value;
        
        if (!documentName || !documentType) {
            showAlert('warning', 'Please enter document name and select type');
            return;
        }
        
        // Add all files to FormData with proper field names
        for (let i = 0; i < fileInput.files.length; i++) {
            formData.append('documents', fileInput.files[i]);
        }
        
        // Add document info
        formData.append('document_name', documentName);
        formData.append('document_type', documentType);
        
        // Show loading state
        const submitBtn = document.getElementById('uploadDocumentBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
        submitBtn.disabled = true;
        
        fetch('/api/upload-document', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showAlert('success', 'Document(s) uploaded successfully!');
                // Reload documents list instead of full page
                if (typeof loadDocuments === 'function') {
                    loadDocuments();
                }
                // Clear form
                uploadDocumentForm.reset();
                if (fileInput) fileInput.value = '';
            } else {
                showAlert('danger', 'Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', 'Error uploading document: ' + error.message);
        })
        .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });
}

function previewDocumentNames(input) {
    const fileList = document.getElementById('documentFileList');
    if (!fileList) return;
    
    fileList.innerHTML = '';
    
    if (input.files && input.files.length > 0) {
        for (let i = 0; i < input.files.length; i++) {
            const file = input.files[i];
            const fileSize = (file.size / (1024 * 1024)).toFixed(2);
            const fileIcon = getFileIcon(file.name);
            
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div class="file-icon">
                    <i class="fas fa-${fileIcon}"></i>
                </div>
                <div class="file-info">
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${fileSize} MB</div>
                </div>
                <div class="file-remove" onclick="removeDocumentFile(${i})">
                    <i class="fas fa-times"></i>
                </div>
            `;
            fileList.appendChild(fileItem);
        }
    }
}

function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    if (['pdf'].includes(ext)) return 'file-pdf';
    if (['doc', 'docx'].includes(ext)) return 'file-word';
    if (['xls', 'xlsx', 'csv'].includes(ext)) return 'file-excel';
    if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(ext)) return 'file-image';
    return 'file';
}

function removeDocumentFile(index) {
    const input = document.getElementById('documentInput');
    if (!input) return;
    
    const files = Array.from(input.files);
    files.splice(index, 1);
    
    // Create new FileList
    const dataTransfer = new DataTransfer();
    files.forEach(file => dataTransfer.items.add(file));
    input.files = dataTransfer.files;
    
    // Update preview
    previewDocumentNames(input);
}

// ==================== FIXED PRINT PROFILE FUNCTION ====================

// Enhanced Print Profile Function - COMPLETELY FIXED
function printProfile() {
    try {
        // Show loading indicator
        const printBtn = document.getElementById('printProfileBtn');
        if (!printBtn) return;
        
        const originalContent = printBtn.innerHTML;
        printBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Preparing...';
        printBtn.disabled = true;
        
        // Get all required data from the page
        const profileNameElem = document.getElementById('profileName');
        const profileRankElem = document.getElementById('profileRank');
        const profileDepartmentElem = document.getElementById('profileDepartment');
        const profileLocationElem = document.getElementById('profileLocation');
        
        if (!profileNameElem || !profileRankElem) {
            showAlert('danger', 'Cannot load profile information');
            printBtn.innerHTML = originalContent;
            printBtn.disabled = false;
            return;
        }
        
        const profileName = profileNameElem.textContent;
        const profileRank = profileRankElem.textContent;
        const profileDepartment = profileDepartmentElem ? profileDepartmentElem.textContent : 'No Department';
        const profileLocation = profileLocationElem ? profileLocationElem.textContent : 'No Location';
        
        // Get stats
        const totalEvaluations = document.getElementById('totalEvaluations')?.textContent || '0';
        const avgSQI = document.getElementById('avgSQI')?.textContent || '0';
        const documentsCount = document.getElementById('documentsCount')?.textContent || '0';
        const activityDays = document.querySelector('.stat-value:nth-child(4)')?.textContent.replace('d', '') || '0';
        
        // Get user data from form inputs
        const firstNameInput = document.getElementById('firstNameInput');
        const lastNameInput = document.getElementById('lastNameInput');
        const phoneInput = document.getElementById('phoneInput');
        const emailInput = document.querySelector('input[type="email"]');
        
        const firstName = firstNameInput ? firstNameInput.value : '';
        const lastName = lastNameInput ? lastNameInput.value : '';
        const phone = phoneInput ? phoneInput.value : '';
        const email = emailInput ? emailInput.value : '';
        
        // Get account info
        const accountInputs = document.querySelectorAll('.card-body input[readonly]');
        const memberSince = accountInputs.length > 0 ? accountInputs[0].value : 'N/A';
        const lastLogin = accountInputs.length > 1 ? accountInputs[1].value : 'Never';
        const lastActivity = accountInputs.length > 2 ? accountInputs[2].value : 'None';
        
        // Get signature preview
        const signaturePreview = document.getElementById('signaturePreview');
        let signatureHTML = '';
        if (signaturePreview) {
            const signatureImg = signaturePreview.querySelector('img');
            if (signatureImg && signatureImg.src) {
                signatureHTML = `<img src="${signatureImg.src}" style="max-height: 80px; max-width: 300px;" alt="Digital Signature">`;
            } else {
                signatureHTML = '<p style="color: #999; font-style: italic;">No digital signature on file</p>';
            }
        }
        
        // Get profile picture
        let profilePicHTML = '';
        const profilePic = document.getElementById('currentProfilePic');
        const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim() || '#5a4fcf';
        if (profilePic && profilePic.src && !profilePic.src.includes('undefined')) {
            profilePicHTML = `<img src="${profilePic.src}" style="width:100px;height:100px;border-radius:50%;object-fit:cover;border:3px solid ${primaryColor};" alt="Profile Picture">`;
        } else {
            profilePicHTML = `<div style="width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg, ${primaryColor}20, ${primaryColor}10);display:inline-flex;align-items:center;justify-content:center;border:3px solid ${primaryColor};"><i class="fas fa-user" style="font-size:40px;color:${primaryColor};"></i></div>`;
        }
        
        // Get role badge
        const roleBadgeElem = document.querySelector('.badge.fs-6');
        const roleBadge = roleBadgeElem ? roleBadgeElem.textContent : 'Unknown Role';
        
        // Get status badge
        const statusBadgeElems = document.querySelectorAll('.badge.fs-6');
        const statusBadge = statusBadgeElems.length > 3 ? statusBadgeElems[3] : null;
        const isApproved = statusBadge ? statusBadge.textContent === 'Approved' : false;
        
        // Get current date
        const currentDate = new Date().toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        const currentTime = new Date().toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // Get logo path - use absolute URL for print
        const logoPath = window.location.origin + '{{ url_for("static", filename="images/logo.png") }}';
        
        // Create print content
        const printContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Profile - ${profileName}</title>
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap');
                    
                    @media print {
                        @page {
                            margin: 0.4in;
                            size: letter;
                        }
                        body {
                            font-size: 10pt;
                        }
                    }
                    
                    * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                    }
                    
                    body {
                        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                        font-size: 10pt;
                        line-height: 1.4;
                        color: #1e293b;
                        padding: 0;
                        max-width: 100%;
                        background: white;
                        position: relative;
                    }
                    
                    /* Watermark - centered on page */
                    body::before {
                        content: '';
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        width: 500px;
                        height: 500px;
                        background-image: url('${logoPath}');
                        background-repeat: no-repeat;
                        background-position: center;
                        background-size: contain;
                        opacity: 0.08;
                        z-index: 0;
                        pointer-events: none;
                    }
                    
                    body > * {
                        position: relative;
                        z-index: 1;
                    }
                    
                    .container {
                        position: relative;
                        z-index: 1;
                        max-width: 100%;
                    }
                    
                    .header {
                        position: relative;
                        text-align: center;
                        margin-bottom: 12px;
                        padding-bottom: 10px;
                        border-bottom: 3px solid var(--primary-color, #5a4fcf);
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                    }
                    
                    .header-center {
                        flex: 1;
                        text-align: center;
                    }
                    
                    .header-logo {
                        position: absolute;
                        right: 0;
                        top: 0;
                        width: 100px;
                        height: 100px;
                        border-radius: 50%;
                        border: 3px solid var(--primary-color, #5a4fcf);
                        object-fit: cover;
                        background: white;
                        padding: 2px;
                        overflow: hidden;
                    }
                    
                    .header-logo img {
                        width: 100%;
                        height: 100%;
                        border-radius: 50%;
                        object-fit: cover;
                    }
                    
                    .header h1 {
                        font-family: 'Inter', sans-serif;
                        font-size: 20pt;
                        font-weight: 700;
                        color: var(--primary-color, #5a4fcf);
                        margin-bottom: 4px;
                        letter-spacing: 1px;
                    }
                    
                    .header p {
                        font-size: 8pt;
                        color: #64748b;
                        margin: 2px 0;
                    }
                    
                    .header .subtitle {
                        font-size: 9pt;
                        color: #475569;
                        font-weight: 500;
                    }
                    
                    .profile-section {
                        display: flex;
                        align-items: center;
                        gap: 20px;
                        margin-bottom: 12px;
                        padding: 12px;
                        background: linear-gradient(135deg, rgba(var(--primary-rgb, 90, 79, 207), 0.05), rgba(var(--secondary-rgb, 107, 93, 216), 0.05));
                        border-radius: 8px;
                        border-left: 4px solid var(--primary-color, #5a4fcf);
                    }
                    
                    .profile-photo {
                        flex-shrink: 0;
                    }
                    
                    .profile-photo img,
                    .profile-photo div {
                        width: 100px;
                        height: 100px;
                        border-radius: 50%;
                        border: 3px solid var(--primary-color, #5a4fcf);
                    }
                    
                    .profile-info h2 {
                        font-size: 16pt;
                        font-weight: 600;
                        color: #0f172a;
                        margin-bottom: 4px;
                    }
                    
                    .profile-info h3 {
                        font-size: 10pt;
                        color: #475569;
                        font-weight: 500;
                        margin: 0;
                    }
                    
                    .stats-grid {
                        display: grid;
                        grid-template-columns: repeat(4, 1fr);
                        gap: 8px;
                        margin-bottom: 12px;
                    }
                    
                    .stat-box {
                        text-align: center;
                        padding: 10px 8px;
                        background: white;
                        border: 1.5px solid #e2e8f0;
                        border-radius: 6px;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
                    }
                    
                    .stat-value {
                        font-size: 18pt;
                        font-weight: 700;
                        color: var(--primary-color, #5a4fcf);
                        margin-bottom: 3px;
                        line-height: 1.2;
                    }
                    
                    .stat-label {
                        font-size: 7pt;
                        color: #64748b;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        font-weight: 600;
                    }
                    
                    .content-grid {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 12px;
                        margin-bottom: 12px;
                    }
                    
                    .section {
                        background: white;
                        border: 1px solid #e2e8f0;
                        border-radius: 6px;
                        padding: 10px;
                        page-break-inside: avoid;
                    }
                    
                    .section-title {
                        font-size: 9pt;
                        font-weight: 700;
                        color: var(--primary-color, #5a4fcf);
                        margin-bottom: 8px;
                        padding-bottom: 6px;
                        border-bottom: 2px solid rgba(var(--primary-rgb, 90, 79, 207), 0.2);
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }
                    
                    .info-grid {
                        display: grid;
                        grid-template-columns: 90px 1fr;
                        gap: 6px 10px;
                        font-size: 8.5pt;
                    }
                    
                    .label {
                        font-weight: 600;
                        color: #475569;
                    }
                    
                    .value {
                        color: #1e293b;
                    }
                    
                    .badge {
                        display: inline-block;
                        padding: 2px 8px;
                        border-radius: 12px;
                        font-size: 7.5pt;
                        font-weight: 600;
                        margin-right: 4px;
                    }
                    
                    .badge-primary { 
                        background: var(--primary-color, #5a4fcf); 
                        color: white; 
                    }
                    .badge-success { 
                        background: #10b981; 
                        color: white; 
                    }
                    .badge-warning { 
                        background: #f59e0b; 
                        color: white; 
                    }
                    
                    .signature-section {
                        margin-top: 12px;
                        padding-top: 12px;
                        border-top: 2px dashed #cbd5e1;
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 12px;
                    }
                    
                    .signature-box {
                        height: 60px;
                        border-bottom: 2px solid #1e293b;
                        margin-top: 8px;
                        position: relative;
                    }
                    
                    .signature-label {
                        position: absolute;
                        bottom: -18px;
                        left: 0;
                        font-size: 7pt;
                        color: #64748b;
                    }
                    
                    .signature-info {
                        text-align: center;
                        margin-top: 20px;
                    }
                    
                    .signature-info strong {
                        font-size: 9pt;
                        color: #0f172a;
                    }
                    
                    .signature-info div {
                        font-size: 7.5pt;
                        color: #475569;
                        margin-top: 4px;
                    }
                    
                    .signature-footer {
                        margin-top: 12px;
                        padding-top: 12px;
                        border-top: 1px solid #e2e8f0;
                        text-align: center;
                        font-size: 8.5pt;
                        color: #1e293b;
                        line-height: 1.8;
                    }
                    
                    .signature-footer strong {
                        font-size: 10pt;
                        color: #0f172a;
                    }
                    
                    .signature-footer .signature-date {
                        font-size: 7.5pt;
                        color: #475569;
                        margin-top: 8px;
                        padding-top: 8px;
                        border-top: 1px solid #e2e8f0;
                    }
                    
                    .footer {
                        margin-top: 8px;
                        padding-top: 10px;
                        border-top: 1px solid #e2e8f0;
                        font-size: 7pt;
                        color: #64748b;
                        text-align: center;
                        line-height: 1.6;
                    }
                    
                    .no-print { display: none; }
                </style>
            </head>
            <body>
                <div class="container">
                <div class="header">
                        <div class="header-center">
                            <h1>VesselOS</h1>
                            <p class="subtitle">International VesselOS Management System</p>
                            <p>Employee Profile Document - Confidential</p>
                            <p>Generated: ${currentDate} at ${currentTime}</p>
                        </div>
                        <div class="header-logo">
                            <img src="${logoPath}" alt="Logo">
                        </div>
                </div>
                
                    <div class="profile-section">
                <div class="profile-photo">
                    ${profilePicHTML}
                        </div>
                        <div class="profile-info">
                            <h2>${profileName}</h2>
                            <h3>${profileRank} • ${roleBadge}</h3>
                        </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value">${totalEvaluations}</div>
                        <div class="stat-label">Total Evaluations</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${avgSQI}</div>
                        <div class="stat-label">Avg SQI Score</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${documentsCount}</div>
                        <div class="stat-label">Documents</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${activityDays}</div>
                        <div class="stat-label">Activity Days</div>
                    </div>
                </div>
                
                    <div class="content-grid">
                <div class="section">
                    <div class="section-title">Personal Information</div>
                    <div class="info-grid">
                        <div class="label">Full Name:</div>
                                <div class="value">${firstName} ${lastName}</div>
                        <div class="label">Role:</div>
                                <div class="value">
                                    <span class="badge badge-primary">${roleBadge}</span>
                        </div>
                                <div class="label">Rank:</div>
                                <div class="value">${profileRank}</div>
                        <div class="label">Department:</div>
                                <div class="value">${profileDepartment}</div>
                        <div class="label">Location:</div>
                                <div class="value">${profileLocation}</div>
                        <div class="label">Status:</div>
                                <div class="value">
                            <span class="badge ${isApproved ? 'badge-success' : 'badge-warning'}">
                                        ${isApproved ? 'Approved' : 'Pending'}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                            <div class="section-title">Contact & Account</div>
                    <div class="info-grid">
                        <div class="label">Email:</div>
                                <div class="value">${email}</div>
                        <div class="label">Phone:</div>
                                <div class="value">${phone || 'Not provided'}</div>
                        <div class="label">Member Since:</div>
                                <div class="value">${memberSince}</div>
                        <div class="label">Last Login:</div>
                                <div class="value">${lastLogin}</div>
                        <div class="label">Last Activity:</div>
                                <div class="value">${lastActivity}</div>
                            </div>
                    </div>
                </div>
                
                <div class="signature-section">
                        <div>
                    <div class="section-title">Digital Signature</div>
                            <div style="margin-bottom: 8px; min-height: 50px;">
                        ${signatureHTML}
                    </div>
                    <div class="signature-box">
                        <div class="signature-label">Signature</div>
                    </div>
                        </div>
                        </div>
                    
                    <div class="signature-footer">
                        <strong>${profileName}</strong>
                        <div>${profileRank}</div>
                        <div>${profileDepartment} ${profileLocation ? '• ' + profileLocation : ''}</div>
                        <div class="signature-date">Date: ${currentDate}</div>
                </div>
                
                <div class="footer">
                        <p><strong>VesselOS</strong> • Version 2.0 • ISO 9001:2015 Certified</p>
                        <p>Generated: ${currentDate} at ${currentTime}</p>
                        <p style="font-size: 6pt; margin-top: 4px;">This document contains confidential information. Unauthorized distribution is prohibited.</p>
                    </div>
                </div>
            </body>
            </html>
        `;
        
        // Create print window
        const printWindow = window.open('', '_blank');
        if (!printWindow) {
            showAlert('warning', 'Please allow pop-ups to print the profile');
            printBtn.innerHTML = originalContent;
            printBtn.disabled = false;
            return;
        }
        
        printWindow.document.write(printContent);
        printWindow.document.close();
        
        // Auto-print after content loads
        printWindow.onload = function() {
            setTimeout(function() {
                printWindow.print();
                printWindow.onafterprint = function() {
                    printWindow.close();
                };
            }, 500);
        };
        
        showAlert('success', 'Print window opened. If it doesn\'t print automatically, use Ctrl+P in the new window.');
        
    } catch (error) {
        console.error('Error printing profile:', error);
        showAlert('danger', 'Error printing profile: ' + error.message);
    } finally {
        // Restore button state after a delay
        const printBtn = document.getElementById('printProfileBtn');
        if (printBtn) {
            setTimeout(() => {
                printBtn.innerHTML = '<i class="fas fa-print me-2"></i> Print Profile';
                printBtn.disabled = false;
            }, 2000);
        }
    }
}

// ==================== FIXED SIGNATURE UPLOAD ====================

// Initialize canvas
function initCanvas() {
    const canvas = document.getElementById('signatureCanvas');
    if (canvas) {
        signatureCanvas = canvas;
        signatureCtx = canvas.getContext('2d');
        signatureCtx.strokeStyle = '#000000';
        signatureCtx.lineWidth = 2;
        signatureCtx.lineCap = 'round';
        signatureCtx.lineJoin = 'round';
    }
}

function initSignatureCanvas() {
    const canvas = document.getElementById('signatureCanvas');
    if (canvas) {
        signatureCanvas = canvas;
        signatureCtx = canvas.getContext('2d');
        signatureCtx.strokeStyle = '#000000';
        signatureCtx.lineWidth = 2;
        signatureCtx.lineCap = 'round';
        signatureCtx.lineJoin = 'round';
        
        // Clear canvas
        signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        
        // Reset drawing variables
        canvasPaths = [];
        currentPath = [];
        isDrawing = false;
        
        // Drawing events
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        
        // Touch events for mobile
        canvas.addEventListener('touchstart', startDrawingTouch);
        canvas.addEventListener('touchmove', drawTouch);
        canvas.addEventListener('touchend', stopDrawing);
    }
}

function startDrawing(e) {
    e.preventDefault();
    isDrawing = true;
    currentPath = [];
    const rect = signatureCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    currentPath.push({x, y});
    draw(e);
}

function startDrawingTouch(e) {
    e.preventDefault();
    isDrawing = true;
    currentPath = [];
    const rect = signatureCanvas.getBoundingClientRect();
    const touch = e.touches[0];
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    currentPath.push({x, y});
    drawTouch(e);
}

function draw(e) {
    if (!isDrawing) return;
    e.preventDefault();
    
    const rect = signatureCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    currentPath.push({x, y});
    
    signatureCtx.beginPath();
    if (currentPath.length >= 2) {
        signatureCtx.moveTo(currentPath[currentPath.length - 2].x, currentPath[currentPath.length - 2].y);
        signatureCtx.lineTo(x, y);
        signatureCtx.stroke();
    }
}

function drawTouch(e) {
    if (!isDrawing) return;
    e.preventDefault();
    
    const rect = signatureCanvas.getBoundingClientRect();
    const touch = e.touches[0];
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    
    currentPath.push({x, y});
    
    signatureCtx.beginPath();
    if (currentPath.length >= 2) {
        signatureCtx.moveTo(currentPath[currentPath.length - 2].x, currentPath[currentPath.length - 2].y);
        signatureCtx.lineTo(x, y);
        signatureCtx.stroke();
    }
}

function stopDrawing() {
    if (isDrawing && currentPath.length > 0) {
        canvasPaths.push([...currentPath]);
    }
    isDrawing = false;
}

function clearCanvas() {
    if (signatureCtx) {
        signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        canvasPaths = [];
    }
}

function undoCanvas() {
    if (canvasPaths.length > 0) {
        canvasPaths.pop();
        redrawCanvas();
    }
}

function redrawCanvas() {
    if (!signatureCtx) return;
    
    signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    canvasPaths.forEach(path => {
        if (path.length > 1) {
            signatureCtx.beginPath();
            signatureCtx.moveTo(path[0].x, path[0].y);
            for (let i = 1; i < path.length; i++) {
                signatureCtx.lineTo(path[i].x, path[i].y);
            }
            signatureCtx.stroke();
        }
    });
}

function saveCanvasSignature() {
    if (!signatureCanvas) return;
    
    const dataURL = signatureCanvas.toDataURL('image/png');
    
    // Convert dataURL to blob
    fetch(dataURL)
        .then(res => res.blob())
        .then(blob => {
            const file = new File([blob], `signature_${Date.now()}.png`, { type: 'image/png' });
            
            // Create a fake input element to set the file
            const input = document.getElementById('signatureInput');
            if (!input) return;
            
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            input.files = dataTransfer.files;
            
            // Preview the signature
            previewSignature(input);
            
            showAlert('success', 'Signature created! Click "Upload Signature" to save it.');
        })
        .catch(error => {
            console.error('Error saving canvas signature:', error);
            showAlert('danger', 'Error creating signature: ' + error.message);
        });
}

// Signature handling
function showSignatureModal() {
    const modal = new bootstrap.Modal(document.getElementById('signatureModal'));
    modal.show();
}

function previewSignature(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Check file size (5MB limit)
        if (file.size > 5 * 1024 * 1024) {
            showAlert('danger', 'File size exceeds 5MB limit');
            input.value = '';
            return;
        }
        
        // Check file type
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        if (!validTypes.includes(file.type.toLowerCase())) {
            showAlert('danger', 'Invalid file type. Please upload JPG, PNG, or GIF');
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewImage = document.getElementById('signaturePreviewImage');
            const previewContainer = document.getElementById('signaturePreviewContainer');
            const uploadBtn = document.getElementById('uploadSignatureBtn');
            
            if (previewImage) previewImage.src = e.target.result;
            if (previewContainer) previewContainer.style.display = 'block';
            if (uploadBtn) uploadBtn.disabled = false;
        };
        reader.readAsDataURL(file);
    }
}

function uploadSignature() {
    const input = document.getElementById('signatureInput');
    if (!input || !input.files[0]) {
        showAlert('warning', 'Please select or create a signature first');
        return;
    }
    
    const formData = new FormData();
    formData.append('signature', input.files[0]);
    
    // Show loading
    const uploadBtn = document.getElementById('uploadSignatureBtn');
    if (!uploadBtn) return;
    
    const originalText = uploadBtn.innerHTML;
    uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
    uploadBtn.disabled = true;
    
    fetch('/api/upload-signature', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showAlert('success', 'Signature uploaded successfully!');
            
            // Update the preview in the modal
            const currentSignatureImg = document.getElementById('currentSignatureImg');
            const signaturePreviewContainer = document.getElementById('signaturePreviewContainer');
            
            if (currentSignatureImg) {
                currentSignatureImg.src = URL.createObjectURL(input.files[0]);
            }
            
            // Update the main page preview
            const mainPreview = document.getElementById('signaturePreview');
            if (mainPreview) {
                mainPreview.innerHTML = `<img src="${URL.createObjectURL(input.files[0])}" class="img-fluid" style="max-height: 100px;" alt="Signature">`;
            }
            
            // Reset form
            input.value = '';
            if (signaturePreviewContainer) signaturePreviewContainer.style.display = 'none';
            clearCanvas();
            
            // Close modal after delay
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('signatureModal'));
                if (modal) {
                    modal.hide();
                }
            }, 1500);
        } else {
            showAlert('danger', 'Error: ' + (data.error || 'Upload failed'));
            uploadBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error uploading signature:', error);
        showAlert('danger', 'Error uploading signature: ' + error.message);
        uploadBtn.disabled = false;
    })
    .finally(() => {
        uploadBtn.innerHTML = originalText;
    });
}

function removeSignature() {
    if (!confirm('Are you sure you want to remove your digital signature?')) {
        return;
    }
    
    fetch('/api/remove-signature', {
        method: 'POST'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showAlert('success', 'Signature removed successfully!');
            
            // Update the modal preview
            const modalPreview = document.getElementById('modalSignaturePreview');
            if (modalPreview) {
                modalPreview.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-signature fa-4x text-muted mb-3"></i>
                        <p class="text-muted">No signature uploaded</p>
                    </div>
                `;
            }
            
            // Update the main page preview
            const mainPreview = document.getElementById('signaturePreview');
            if (mainPreview) {
                mainPreview.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-signature fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No signature uploaded</p>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="showSignatureModal()">
                            <i class="fas fa-upload me-1"></i> Upload Signature
                        </button>
                    </div>
                `;
            }
        } else {
            showAlert('danger', 'Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error removing signature:', error);
        showAlert('danger', 'Error removing signature: ' + error.message);
    });
}

// ==================== OTHER PROFILE FUNCTIONS ====================

// Drag and drop functionality
function setupDragAndDrop() {
    const uploadAreas = ['profilePicUploadArea', 'documentUploadArea', 'signatureUploadArea', 'messageAttachmentArea'];
    
    uploadAreas.forEach(areaId => {
        const area = document.getElementById(areaId);
        if (!area) return;
        
        area.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });
        
        area.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
        });
        
        area.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                if (areaId === 'profilePicUploadArea') {
                    const input = document.getElementById('profilePicInput');
                    if (input) {
                        input.files = files;
                        previewProfilePic(input);
                    }
                } else if (areaId === 'documentUploadArea') {
                    const input = document.getElementById('documentInput');
                    if (input) {
                        input.files = files;
                        previewDocumentNames(input);
                    }
                } else if (areaId === 'signatureUploadArea') {
                    const input = document.getElementById('signatureInput');
                    if (input) {
                        input.files = files;
                        previewSignature(input);
                    }
                } else if (areaId === 'messageAttachmentArea') {
                    const input = document.getElementById('messageAttachment');
                    if (input) {
                        input.files = files;
                        previewAttachments(input);
                    }
                }
            }
        });
    });
}

// Password strength checker
function checkPasswordStrength(password) {
    let strength = 0;
    const bar = document.getElementById('passwordStrengthBar');
    if (!bar) return;
    
    if (password.length >= 8) strength++;
    if (/[a-z]/.test(password)) strength++;
    if (/[A-Z]/.test(password)) strength++;
    if (/[0-9]/.test(password)) strength++;
    if (/[^A-Za-z0-9]/.test(password)) strength++;
    
    const percent = (strength / 5) * 100;
    bar.style.width = percent + '%';
    
    bar.className = 'password-strength-bar ';
    if (strength <= 2) bar.className += 'strength-weak';
    else if (strength === 3) bar.className += 'strength-fair';
    else if (strength === 4) bar.className += 'strength-good';
    else bar.className += 'strength-strong';
}

// Change password form
const changePasswordForm = document.getElementById('changePasswordForm');
if (changePasswordForm) {
    changePasswordForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {};
        formData.forEach((value, key) => data[key] = value);
        
        if (data.new_password !== data.confirm_password) {
            showAlert('danger', 'New passwords do not match');
            return;
        }
        
        // Show loading state
        const submitBtn = document.getElementById('changePasswordBtn');
        if (!submitBtn) return;
        
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Changing...';
        submitBtn.disabled = true;
        
        fetch('/api/change-password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showAlert('success', 'Password changed successfully!');
                this.reset();
                const passwordStrengthBar = document.getElementById('passwordStrengthBar');
                if (passwordStrengthBar) passwordStrengthBar.style.width = '0%';
            } else {
                showAlert('danger', 'Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error changing password:', error);
            showAlert('danger', 'Error: ' + error.message);
        })
        .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });
}

// Activity log
function loadActivityData() {
    fetch('/api/user/activities')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateActivityTable(data.activities);
            }
        })
        .catch(error => console.error('Error loading activities:', error));
}

function updateActivityTable(activities) {
    const table = document.getElementById('activityTable');
    if (!table) return;
    
    if (!activities || activities.length === 0) {
        table.innerHTML = `
            <tr>
                <td colspan="4" class="text-center py-4">
                    <i class="fas fa-history fa-2x text-muted mb-3"></i>
                    <p class="text-muted">No activities found</p>
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    activities.forEach(activity => {
        const time = activity.timestamp ? new Date(activity.timestamp).toLocaleString() : 'Unknown';
        const icon = activity.activity === 'login' ? 'sign-in-alt' :
                    activity.activity === 'logout' ? 'sign-out-alt' :
                    activity.activity === 'profile_update' ? 'user-edit' :
                    activity.activity === 'document_upload' ? 'file-upload' :
                    activity.activity === 'message_sent' ? 'paper-plane' :
                    activity.activity === 'message_replied' ? 'reply' : 'clipboard-check';
        
        html += `
            <tr>
                <td><small class="text-muted">${time}</small></td>
                <td>
                    <i class="fas fa-${icon} me-2 text-primary"></i>
                    ${activity.activity.replace('_', ' ')}
                </td>
                <td>${activity.details || 'No details'}</td>
                <td><code>${activity.ip_address || 'N/A'}</code></td>
            </tr>
        `;
    });
    
    table.innerHTML = html;
}

// Document management functions
function downloadDocument(docId, docName) {
    // Show loading message
    showAlert('info', `Downloading ${docName}...`);
    
    // Create hidden iframe for download
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = `/api/download-document/${docId}`;
    document.body.appendChild(iframe);
    
    // Remove iframe after download starts
    setTimeout(() => {
        if (iframe.parentNode) {
            document.body.removeChild(iframe);
        }
    }, 5000);
}

function previewDocument(docId) {
    // Show loading in modal
    const previewContent = document.getElementById('documentPreviewContent');
    if (!previewContent) return;
    
    previewContent.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading document...</p>
        </div>
    `;
    
    // Show modal first
    const modal = new bootstrap.Modal(document.getElementById('documentPreviewModal'));
    modal.show();
    
    // Fetch document info
    fetch(`/api/document-info/${docId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const doc = data.document;
                const title = document.getElementById('documentPreviewTitle');
                if (title) title.textContent = doc.document_name;
                
                // Format file size
                let fileSize = 'Unknown';
                if (doc.file_size) {
                    fileSize = formatFileSize(doc.file_size);
                }
                
                // Format date
                let uploadDate = 'Unknown';
                if (doc.uploaded_at) {
                    try {
                        const date = new Date(doc.uploaded_at);
                        uploadDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                    } catch (e) {
                        uploadDate = doc.uploaded_at;
                    }
                }
                
                // Get appropriate icon based on file type
                const fileExt = doc.document_path ? doc.document_path.split('.').pop().toLowerCase() : '';
                let fileIcon = 'file';
                let fileType = 'Document';
                
                if (fileExt === 'pdf') {
                    fileIcon = 'file-pdf';
                    fileType = 'PDF Document';
                } else if (['doc', 'docx'].includes(fileExt)) {
                    fileIcon = 'file-word';
                    fileType = 'Word Document';
                } else if (['xls', 'xlsx', 'csv'].includes(fileExt)) {
                    fileIcon = 'file-excel';
                    fileType = 'Spreadsheet';
                } else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExt)) {
                    fileIcon = 'file-image';
                    fileType = 'Image';
                }
                
                // Create preview content
                previewContent.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-${fileIcon} fa-4x text-primary mb-3"></i>
                        <h4>${doc.document_name}</h4>
                        <p class="text-muted">
                            <strong>Type:</strong> ${doc.document_type || fileType}<br>
                            <strong>Size:</strong> ${fileSize}<br>
                            <strong>Uploaded:</strong> ${uploadDate}<br>
                            <strong>Document ID:</strong> ${doc.id}
                        </p>
                        <div class="d-flex justify-content-center gap-2 mt-4">
                            <button class="btn btn-primary" onclick="downloadDocument('${docId}', '${doc.document_name}')">
                                <i class="fas fa-download me-2"></i> Download
                            </button>
                            <button class="btn btn-outline-secondary" onclick="renameDocument('${docId}', '${doc.document_name}')">
                                <i class="fas fa-edit me-2"></i> Rename
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteDocument('${docId}', '${doc.document_name}')">
                                <i class="fas fa-trash me-2"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
                
                // Store current document ID for download button in modal footer
                const modalElem = document.getElementById('documentPreviewModal');
                if (modalElem) {
                    modalElem.setAttribute('data-current-doc-id', docId);
                    modalElem.setAttribute('data-current-doc-name', doc.document_name);
                }
                
            } else {
                previewContent.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error: ${data.error || 'Failed to load document information'}
                    </div>
                `;
            }
        })
        .catch(error => {
            previewContent.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Network error: ${error.message}
                </div>
            `;
        });
}

function renameDocument(docId, currentName) {
    const newName = prompt('Enter new document name:', currentName);
    if (newName && newName.trim() !== currentName.trim()) {
        // Show loading
        showAlert('info', 'Renaming document...');
        
        fetch(`/api/rename-document/${docId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({new_name: newName.trim()})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'Document renamed successfully!');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert('danger', 'Error: ' + data.error);
            }
        })
        .catch(error => {
            showAlert('danger', 'Error: ' + error.message);
        });
    }
}

function deleteDocument(docId, docName) {
    if (confirm(`Are you sure you want to delete "${docName}"? This action cannot be undone.`)) {
        // Show loading
        showAlert('info', 'Deleting document...');
        
        fetch(`/api/delete-document/${docId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'Document deleted successfully!');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert('danger', 'Error: ' + data.error);
            }
        })
        .catch(error => {
            showAlert('danger', 'Error: ' + error.message);
        });
    }
}

// Document selection functions
function toggleDocumentSelection(docId, checkbox) {
    const card = checkbox.closest('.card');
    if (checkbox.checked) {
        selectedDocuments.add(docId);
        if (card) card.style.backgroundColor = '#f0f8ff';
    } else {
        selectedDocuments.delete(docId);
        if (card) card.style.backgroundColor = '';
        // Uncheck select all if any document is unchecked
        const selectAll = document.getElementById('selectAllDocuments');
        if (selectAll) selectAll.checked = false;
    }
}

function toggleSelectAllDocuments(checkbox) {
    const checkboxes = document.querySelectorAll('.document-checkbox');
    
    if (checkbox.checked) {
        checkboxes.forEach(cb => {
            const docId = cb.getAttribute('data-doc-id');
            if (docId) {
                selectedDocuments.add(docId);
                cb.checked = true;
                const card = cb.closest('.card');
                if (card) {
                    card.style.backgroundColor = '#f0f8ff';
                }
            }
        });
    } else {
        checkboxes.forEach(cb => {
            const docId = cb.getAttribute('data-doc-id');
            if (docId) {
                selectedDocuments.delete(docId);
                cb.checked = false;
                const card = cb.closest('.card');
                if (card) {
                    card.style.backgroundColor = '';
                }
            }
        });
    }
}

function downloadSelectedDocuments() {
    if (selectedDocuments.size === 0) {
        showAlert('warning', 'Please select documents to download');
        return;
    }
    
    if (selectedDocuments.size === 1) {
        // Download single document
        const docId = Array.from(selectedDocuments)[0];
        // Find the document name
        const checkbox = document.querySelector(`.document-checkbox[data-doc-id="${docId}"]`);
        if (checkbox) {
            const card = checkbox.closest('.card');
            if (card) {
                const docName = card.querySelector('.card-title')?.textContent.trim() || 'document';
                downloadDocument(docId, docName);
            }
        }
    } else {
        // For multiple documents, show message
        showAlert('info', `Downloading ${selectedDocuments.size} documents individually...`);
        
        // Download each document one by one
        let delay = 0;
        selectedDocuments.forEach(docId => {
            setTimeout(() => {
                const checkbox = document.querySelector(`.document-checkbox[data-doc-id="${docId}"]`);
                if (checkbox) {
                    const card = checkbox.closest('.card');
                    if (card) {
                        const docName = card.querySelector('.card-title')?.textContent.trim() || 'document';
                        downloadDocument(docId, docName);
                    }
                }
            }, delay);
            delay += 500;
        });
    }
}

function deleteSelectedDocuments() {
    if (selectedDocuments.size === 0) {
        showAlert('warning', 'Please select documents to delete');
        return;
    }
    
    if (confirm(`Delete ${selectedDocuments.size} selected documents? This action cannot be undone.`)) {
        showAlert('info', `Deleting ${selectedDocuments.size} documents...`);
        
        fetch('/api/delete-documents', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({document_ids: Array.from(selectedDocuments)})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', `Successfully deleted ${data.deleted_count} documents!`);
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert('danger', 'Error: ' + data.error);
            }
        })
        .catch(error => {
            showAlert('danger', 'Error: ' + error.message);
        });
    }
}

function downloadCurrentDocument() {
    const modal = document.getElementById('documentPreviewModal');
    if (!modal) return;
    
    const docId = modal.getAttribute('data-current-doc-id');
    const docName = modal.getAttribute('data-current-doc-name');
    
    if (docId && docName) {
        downloadDocument(docId, docName);
    } else {
        showAlert('warning', 'No document selected for download');
    }
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Quick action functions
function generateProfileReport() {
    showAlert('info', 'Generating profile report...');
    
    fetch('/api/generate-profile-report', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Create PDF download
            const blob = new Blob([data.report_content || 'Profile Report'], {type: 'application/pdf'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `profile_report_${new Date().toISOString().slice(0,10)}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showAlert('success', 'Profile report generated and downloaded successfully!');
        } else {
            // Fallback: Generate client-side report
            generateClientSideProfileReport();
        }
    })
    .catch(error => {
        console.error('Error generating profile report:', error);
        // Fallback: Generate client-side report
        generateClientSideProfileReport();
    });
}

function generateClientSideProfileReport() {
    const userData = {
        name: document.getElementById('profileName')?.textContent || 'User',
        rank: document.getElementById('profileRank')?.textContent || 'N/A',
        email: '{{ user.email }}',
        phone: document.getElementById('phoneInput')?.value || 'N/A',
        department: document.getElementById('departmentInput')?.value || 'N/A',
        location: document.getElementById('locationInput')?.value || 'N/A',
        generated_at: new Date().toLocaleString()
    };
    
    const reportContent = `
PROFILE REPORT
================

Name: ${userData.name}
Rank: ${userData.rank}
Email: ${userData.email}
Phone: ${userData.phone}
Department: ${userData.department}
Location: ${userData.location}

Generated: ${userData.generated_at}

This is a comprehensive profile report generated from the VesselOS system.
    `;
    
    const blob = new Blob([reportContent], {type: 'text/plain'});
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `profile_report_${new Date().toISOString().slice(0,10)}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    showAlert('success', 'Profile report generated and downloaded successfully!');
}

function downloadPersonalData() {
    fetch('/api/download-personal-data')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const blob = new Blob([JSON.stringify(data.data, null, 2)], {type: 'application/json'});
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `personal_data_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }
        })
        .catch(error => {
            console.error('Error downloading personal data:', error);
            showAlert('danger', 'Error downloading personal data: ' + error.message);
        });
}

function requestAccountDeletion() {
    if (confirm('Are you sure you want to request account deletion? This action cannot be undone.')) {
        const reason = prompt('Please provide a reason for deletion:');
        if (reason) {
            fetch('/api/request-account-deletion', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({reason: reason})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', 'Account deletion request submitted. Administrator will contact you.');
                }
            })
            .catch(error => {
                console.error('Error requesting account deletion:', error);
                showAlert('danger', 'Error submitting request: ' + error.message);
            });
        }
    }
}

let current2FASecret = null;

function enableTwoFactor() {
    const modal = new bootstrap.Modal(document.getElementById('twoFactorModal'));
    document.getElementById('2faSetupStep1').style.display = 'block';
    document.getElementById('2faDisableStep').style.display = 'none';
    document.getElementById('qrCodeContainer').innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading QR code...</span></div>';
    document.getElementById('manualEntryCode').textContent = '';
    document.getElementById('2faVerificationCode').value = '';
    modal.show();
    
    fetch('/api/2fa/setup')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                current2FASecret = data.secret;
                document.getElementById('manualEntryCode').textContent = data.manual_entry;
                
                // Generate QR code using qrcode.js library (or use a service)
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(data.qr_url)}`;
                document.getElementById('qrCodeContainer').innerHTML = `<img src="${qrUrl}" alt="QR Code" class="img-fluid border rounded">`;
            } else {
                document.getElementById('qrCodeContainer').innerHTML = `<div class="alert alert-danger">${data.error || 'Failed to setup 2FA'}</div>`;
            }
        })
        .catch(error => {
            console.error('Error setting up 2FA:', error);
            document.getElementById('qrCodeContainer').innerHTML = `<div class="alert alert-danger">Network error: ${error.message}</div>`;
        });
}

function verifyAndEnable2FA() {
    const code = document.getElementById('2faVerificationCode').value.trim();
    if (!code || code.length !== 6 || !/^\d{6}$/.test(code)) {
        showAlert('warning', 'Please enter a valid 6-digit code');
        return;
    }
    
    fetch('/api/csrf-token')
        .then(r => r.json())
        .then(csrfData => {
            return fetch('/api/2fa/enable', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    code: code,
                    csrf_token: csrfData.csrf_token
                })
            });
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', '2FA enabled successfully!');
                bootstrap.Modal.getInstance(document.getElementById('twoFactorModal')).hide();
                load2FAStatus();
            } else {
                showAlert('danger', data.error || 'Failed to enable 2FA');
            }
        })
        .catch(error => {
            console.error('Error enabling 2FA:', error);
            showAlert('danger', 'Network error: ' + error.message);
        });
}

function disableTwoFactor() {
    const modal = new bootstrap.Modal(document.getElementById('twoFactorModal'));
    document.getElementById('2faSetupStep1').style.display = 'none';
    document.getElementById('2faDisableStep').style.display = 'block';
    document.getElementById('2faDisableCode').value = '';
    modal.show();
}

function confirmDisable2FA() {
    const code = document.getElementById('2faDisableCode').value.trim();
    if (!code || code.length !== 6 || !/^\d{6}$/.test(code)) {
        showAlert('warning', 'Please enter a valid 6-digit code');
        return;
    }
    
    fetch('/api/csrf-token')
        .then(r => r.json())
        .then(csrfData => {
            return fetch('/api/2fa/disable', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    code: code,
                    csrf_token: csrfData.csrf_token
                })
            });
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', '2FA disabled successfully');
                bootstrap.Modal.getInstance(document.getElementById('twoFactorModal')).hide();
                load2FAStatus();
            } else {
                showAlert('danger', data.error || 'Failed to disable 2FA');
            }
        })
        .catch(error => {
            console.error('Error disabling 2FA:', error);
            showAlert('danger', 'Network error: ' + error.message);
        });
}

function load2FAStatus() {
    fetch('/api/2fa/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const statusDiv = document.getElementById('2faStatus');
                const enableBtn = document.getElementById('enable2FABtn');
                const disableBtn = document.getElementById('disable2FABtn');
                
                if (data.enabled) {
                    statusDiv.innerHTML = '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>2FA Enabled</span>';
                    enableBtn.style.display = 'none';
                    disableBtn.style.display = 'inline-block';
                } else {
                    statusDiv.innerHTML = '<span class="badge bg-secondary"><i class="fas fa-times-circle me-1"></i>2FA Disabled</span>';
                    enableBtn.style.display = 'inline-block';
                    disableBtn.style.display = 'none';
                }
            }
        })
        .catch(error => {
            console.error('Error loading 2FA status:', error);
        });
}

function logoutOtherSessions() {
    if (confirm('Logout all other sessions? You will remain logged in on this device.')) {
        fetch('/api/logout-other-sessions', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', 'All other sessions have been logged out.');
                }
            })
            .catch(error => {
                console.error('Error logging out other sessions:', error);
                showAlert('danger', 'Error: ' + error.message);
            });
    }
}

function savePrivacySettings() {
    const settings = {
        profile_visibility: document.getElementById('profileVisibility')?.checked || false,
        activity_sharing: document.getElementById('activitySharing')?.checked || false,
        email_notifications: document.getElementById('emailNotifications')?.checked || false
    };
    
    fetch('/api/save-privacy-settings', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Privacy settings saved successfully!');
        }
    })
    .catch(error => {
        console.error('Error saving privacy settings:', error);
        showAlert('danger', 'Error: ' + error.message);
    });
}

function exportActivityLog() {
    showAlert('info', 'Exporting activity log...');
    
    fetch('/api/user/activities')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.activities) {
                const activities = data.activities;
                let csvContent = 'Timestamp,Activity,Details,IP Address\n';
                
                activities.forEach(activity => {
                    const timestamp = activity.timestamp || 'Unknown';
                    const activityType = activity.activity || 'Unknown';
                    const details = (activity.details || 'No details').replace(/,/g, ';');
                    const ip = activity.ip_address || 'N/A';
                    csvContent += `"${timestamp}","${activityType}","${details}","${ip}"\n`;
                });
                
                const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `activity_log_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                showAlert('success', 'Activity log exported successfully!');
            } else {
                showAlert('warning', 'No activity data available to export');
            }
        })
        .catch(error => {
            console.error('Error exporting activity log:', error);
            showAlert('danger', 'Error exporting activity log: ' + error.message);
        });
}

function sortDocuments(criteria) {
    const grid = document.getElementById('documentsGrid');
    if (!grid) return;
    
    const cards = Array.from(grid.getElementsByClassName('col-lg-4'));
    
    cards.sort((a, b) => {
        const aTitle = a.querySelector('.card-title')?.textContent.trim() || '';
        const bTitle = b.querySelector('.card-title')?.textContent.trim() || '';
        
        if (criteria === 'name') {
            return aTitle.localeCompare(bTitle);
        } else if (criteria === 'date') {
            const aDateText = a.querySelector('.small .fa-calendar')?.parentNode.textContent.split(': ')[1] || '';
            const bDateText = b.querySelector('.small .fa-calendar')?.parentNode.textContent.split(': ')[1] || '';
            const aDate = new Date(aDateText);
            const bDate = new Date(bDateText);
            return bDate - aDate; // Newest first
        } else if (criteria === 'size') {
            const aSizeText = a.querySelector('.small .fa-weight-hanging')?.parentNode.textContent.split(': ')[1] || '';
            const bSizeText = b.querySelector('.small .fa-weight-hanging')?.parentNode.textContent.split(': ')[1] || '';
            
            // Convert sizes to bytes for comparison
            const parseSize = (sizeText) => {
                const match = sizeText.match(/(\d+\.?\d*)\s*(B|KB|MB|GB)/i);
                if (!match) return 0;
                
                const value = parseFloat(match[1]);
                const unit = match[2].toUpperCase();
                
                switch(unit) {
                    case 'KB': return value * 1024;
                    case 'MB': return value * 1024 * 1024;
                    case 'GB': return value * 1024 * 1024 * 1024;
                    default: return value;
                }
            };
            
            const aSize = parseSize(aSizeText);
            const bSize = parseSize(bSizeText);
            return bSize - aSize; // Largest first
        }
        return 0;
    });
    
    cards.forEach(card => grid.appendChild(card));
}

function filterActivities() {
    const type = document.getElementById('activityTypeFilter')?.value || '';
    const startDate = document.getElementById('activityStartDate')?.value || '';
    const endDate = document.getElementById('activityEndDate')?.value || '';
    
    showAlert('info', `Filtering activities by type: ${type || 'all'}, from ${startDate || 'any'} to ${endDate || 'any'}`);
    // Implement actual filtering logic here
}

function loadMoreActivities() {
    showAlert('info', 'Loading more activities...');
    // Implement pagination logic here
}

// Utility functions
function showAlert(type, message) {
    // Remove existing alerts
    const existingAlerts = document.querySelectorAll('.alert.position-fixed');
    existingAlerts.forEach(alert => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    });
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 500px;';
    alertDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
            <div>${message}</div>
            <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

// ==================== MESSAGING FUNCTIONS (from base.html) ====================

// Initialize messaging
function initMessaging() {
    loadUnreadCount();
    // Refresh unread count every 30 seconds
    setInterval(loadUnreadCount, 30000);
}

function initMessageEventListeners() {
    // Close user search dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const searchResults = document.getElementById('userSearchResults');
        const userSearch = document.getElementById('userSearch');
        
        if (userSearch && searchResults && !userSearch.contains(event.target) && !searchResults.contains(event.target)) {
            searchResults.style.display = 'none';
        }
    });
}

// Load unread message count
function loadUnreadCount() {
    fetch('/api/messaging/unread-count')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const badge = document.getElementById('unreadCount');
                if (badge) {
                    badge.textContent = data.count;
                    if (data.count > 0) {
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            }
        })
        .catch(error => console.error('Error loading unread count:', error));
}

// ==================== MESSAGING MODAL FUNCTIONS ====================

// Show Send Message Modal
function showSendMessageModal() {
    const modal = document.getElementById('sendMessageModal');
    if (modal) {
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Reset form when modal is shown
        const form = document.getElementById('sendMessageForm');
        if (form) {
            form.reset();
            // Reset recipient fields
            toggleRecipientFields();
        }
    } else {
        showAlert('warning', 'Send message modal not found. Please refresh the page.');
    }
}

// Show Inbox Modal
function showInbox() {
    const modal = document.getElementById('inboxModal');
    if (modal) {
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Load inbox content when modal is shown
        modal.addEventListener('shown.bs.modal', function loadInboxContent() {
            loadInboxMessages('all');
            modal.removeEventListener('shown.bs.modal', loadInboxContent);
        }, { once: true });
    } else {
        showAlert('warning', 'Inbox modal not found. Please refresh the page.');
    }
}

// Show Sent Messages Modal
function showSentMessagesModal() {
    const modal = document.getElementById('sentMessagesModal');
    if (modal) {
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Load sent messages when modal is shown
        loadSentMessages();
    } else {
        showAlert('warning', 'Sent messages modal not found. Please refresh the page.');
    }
}

// Load inbox messages
function loadInboxMessages(filter = 'all') {
    const inboxContent = document.getElementById('inboxContent');
    if (!inboxContent) return;
    
    inboxContent.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border" role="status" style="color: var(--primary-purple);">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading messages...</p>
        </div>
    `;
    
    fetch(`/api/messaging/inbox?filter=${filter}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.messages) {
                renderInboxMessages(data.messages);
            } else {
                inboxContent.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">No messages found</h6>
                        <p class="text-muted small">Your inbox is empty</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading inbox:', error);
            inboxContent.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error loading messages: ${error.message}
                </div>
            `;
        });
}

// Render inbox messages
function renderInboxMessages(messages) {
    const inboxContent = document.getElementById('inboxContent');
    if (!inboxContent) return;
    
    if (!messages || messages.length === 0) {
        inboxContent.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h6 class="text-muted">No messages found</h6>
                <p class="text-muted small">Your inbox is empty</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="list-group list-group-flush">';
    
    messages.forEach(message => {
        const priorityClass = message.priority === 'urgent' ? 'message-priority-urgent' : 
                            message.priority === 'high' ? 'message-priority-high' : 
                            message.priority === 'low' ? 'message-priority-low' : 'message-priority-normal';
        
        const readClass = message.is_read ? '' : 'message-unread';
        const icon = message.message_type === 'notification' ? 'bell' :
                    message.message_type === 'announcement' ? 'bullhorn' : 'envelope';
        
        html += `
            <a href="#" class="list-group-item list-group-item-action border-0 ${priorityClass} ${readClass}" 
               onclick="openMessageDetail('${message.message_id}'); return false;">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas fa-${icon} fa-lg" style="color: var(--primary-purple);"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between">
                            <strong>${message.sender_name || 'System'}</strong>
                            <small class="text-muted">${formatTimeAgo(message.created_at)}</small>
                        </div>
                        <p class="mb-1">${message.title || 'No title'}</p>
                        ${!message.is_read ? '<span class="badge" style="background: var(--primary-purple);">NEW</span>' : ''}
                    </div>
                </div>
            </a>
        `;
    });
    
    html += '</div>';
    inboxContent.innerHTML = html;
}

// Filter inbox
function filterInbox(filter) {
    // Update active button
    document.querySelectorAll('#inboxModal .btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Load filtered messages
    loadInboxMessages(filter);
}

// Mark all as read
function markAllAsRead() {
    fetch('/api/messaging/mark-all-read', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'All messages marked as read');
            loadInboxMessages('all');
            loadUnreadCount();
        } else {
            showAlert('danger', 'Error: ' + (data.error || 'Failed to mark messages as read'));
        }
    })
    .catch(error => {
        showAlert('danger', 'Error: ' + error.message);
    });
}

// Load sent messages
function loadSentMessages(filterType = 'all', searchQuery = '') {
    const sentMessagesList = document.getElementById('sentMessagesList');
    if (!sentMessagesList) return;
    
    sentMessagesList.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border" role="status" style="color: var(--primary-purple);">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading sent messages...</p>
        </div>
    `;
    
    fetch(`/api/messaging/sent?type=${filterType}&search=${encodeURIComponent(searchQuery)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.messages) {
                renderSentMessages(data.messages);
            } else {
                sentMessagesList.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-paper-plane fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">No sent messages found</h6>
                        <p class="text-muted small">You haven't sent any messages yet</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading sent messages:', error);
            sentMessagesList.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error loading sent messages: ${error.message}
                </div>
            `;
        });
}

// Render sent messages
function renderSentMessages(messages) {
    const sentMessagesList = document.getElementById('sentMessagesList');
    if (!sentMessagesList) return;
    
    if (!messages || messages.length === 0) {
        sentMessagesList.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-paper-plane fa-3x text-muted mb-3"></i>
                <h6 class="text-muted">No sent messages found</h6>
                <p class="text-muted small">You haven't sent any messages yet</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="list-group list-group-flush">';
    
    messages.forEach(message => {
        const isAnnouncement = message.message_type === 'announcement';
        html += `
            <div class="list-group-item border-0 border-bottom">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${message.title || 'No title'}</h6>
                        <p class="mb-1 small text-muted">To: ${message.recipient_name || 'Multiple recipients'}</p>
                        <p class="mb-1 small">${(message.message || '').substring(0, 100)}${(message.message || '').length > 100 ? '...' : ''}</p>
                        <small class="text-muted">${formatTimeAgo(message.created_at)}</small>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge ms-2" style="background: var(--primary-purple);">${message.message_type || 'message'}</span>
                        ${isAnnouncement ? `
                            <button class="btn btn-sm btn-outline-danger" 
                                    onclick="deleteAnnouncement(${JSON.stringify(message.title)}, ${JSON.stringify(message.created_at)})"
                                    title="Delete announcement">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    sentMessagesList.innerHTML = html;
}

// Delete announcement function
function deleteAnnouncement(title, created_at) {
    if (!confirm(`Are you sure you want to delete this announcement?\n\n"${title}"\n\nThis will remove it for all recipients.`)) {
        return;
    }
    
    fetch('/api/messaging/delete-announcement', {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            title: title,
            created_at: created_at
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', `Announcement deleted successfully. ${data.deleted_count || 0} instance(s) removed.`);
            // Reload sent messages
            loadSentMessages();
        } else {
            showAlert('danger', 'Error deleting announcement: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error deleting announcement:', error);
        showAlert('danger', 'Network error deleting announcement.');
    });
}

// Send message function
function sendMessage() {
    const form = document.getElementById('sendMessageForm');
    if (!form) {
        showAlert('danger', 'Message form not found');
        return;
    }
    
    const formData = new FormData(form);
    const messageType = document.getElementById('messageType')?.value;
    const recipientType = document.getElementById('recipientType')?.value;
    
    // Validate required fields
    const title = document.getElementById('messageTitle')?.value;
    const message = document.getElementById('messageText')?.value;
    
    if (!title || !message) {
        showAlert('warning', 'Please fill in all required fields');
        return;
    }
    
    // Show loading state
    const sendBtn = document.getElementById('sendMessageBtn');
    if (!sendBtn) return;
    
    const originalText = sendBtn.innerHTML;
    sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Sending...';
    sendBtn.disabled = true;
    
    fetch('/api/messaging/send', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        sendBtn.innerHTML = originalText;
        sendBtn.disabled = false;
        
        if (data.success) {
            showAlert('success', 'Message sent successfully!');
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('sendMessageModal'));
            if (modal) modal.hide();
            // Reset form
            form.reset();
            // Reload unread count
            loadUnreadCount();
        } else {
            showAlert('danger', 'Error: ' + (data.error || 'Failed to send message'));
        }
    })
    .catch(error => {
        sendBtn.innerHTML = originalText;
        sendBtn.disabled = false;
        showAlert('danger', 'Network error: ' + error.message);
    });
}

// Toggle recipient fields based on recipient type
function toggleRecipientFields() {
    const recipientType = document.getElementById('recipientType')?.value;
    const userField = document.getElementById('userField');
    const roleField = document.getElementById('roleField');
    const departmentField = document.getElementById('departmentField');
    
    if (userField) userField.style.display = recipientType === 'specific_user' ? 'block' : 'none';
    if (roleField) roleField.style.display = recipientType === 'role' ? 'block' : 'none';
    if (departmentField) departmentField.style.display = recipientType === 'department' ? 'block' : 'none';
}

// Toggle reply option based on message type
function toggleReplyOption() {
    const messageType = document.getElementById('messageType')?.value;
    const allowRepliesDiv = document.getElementById('allowRepliesDiv');
    if (allowRepliesDiv) {
        allowRepliesDiv.style.display = messageType === 'message' ? 'block' : 'none';
    }
}

// Search users function
function searchUsers(query) {
    const searchResults = document.getElementById('userSearchResults');
    if (!searchResults) return;
    
    if (!query || query.trim().length < 2) {
        searchResults.style.display = 'none';
        searchResults.innerHTML = '';
        return;
    }
    
    fetch(`/api/messaging/search-users?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.users && data.users.length > 0) {
                searchResults.innerHTML = '';
                data.users.forEach(user => {
                    const item = document.createElement('div');
                    item.className = 'user-search-item';
                    item.innerHTML = `
                        <div class="avatar">
                            ${user.full_name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)}
                        </div>
                        <div class="info">
                            <div class="name">${user.full_name}</div>
                            <div class="details">${user.email} • ${user.role}</div>
                        </div>
                    `;
                    item.onclick = () => {
                        document.getElementById('userId').value = user.user_id;
                        document.getElementById('userEmail').value = user.email;
                        document.getElementById('userPhone').value = user.phone || '';
                        searchResults.style.display = 'none';
                    };
                    searchResults.appendChild(item);
                });
                searchResults.style.display = 'block';
            } else {
                searchResults.innerHTML = '<div class="user-search-item">No users found</div>';
                searchResults.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error searching users:', error);
            searchResults.innerHTML = '<div class="user-search-item">Search error</div>';
            searchResults.style.display = 'block';
        });
}

// Format time ago helper
function formatTimeAgo(dateString) {
    if (!dateString) return 'Unknown';
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} min ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    return date.toLocaleDateString();
}

// Preview attachments
function previewAttachments(input) {
    const fileList = document.getElementById('attachmentList');
    if (!fileList) return;
    
    fileList.innerHTML = '';
    const files = Array.from(input.files);
    
    if (files.length > 0) {
        const fileCountBadge = document.getElementById('fileCountBadge');
        if (fileCountBadge) {
            fileCountBadge.textContent = files.length;
            fileCountBadge.style.display = 'inline-block';
        }
    }
    
    files.forEach((file, index) => {
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <i class="fas fa-file file-icon"></i>
            <div class="file-info">
                <div class="file-name">${file.name}</div>
                <div class="file-size">${fileSize} MB</div>
            </div>
            <i class="fas fa-times file-remove" onclick="removeAttachment(${index})"></i>
        `;
        fileList.appendChild(fileItem);
    });
}

// Remove attachment
function removeAttachment(index) {
    const input = document.getElementById('messageAttachment');
    if (!input) return;
    
    const files = Array.from(input.files);
    files.splice(index, 1);
    
    const dataTransfer = new DataTransfer();
    files.forEach(file => dataTransfer.items.add(file));
    input.files = dataTransfer.files;
    
    previewAttachments(input);
}

// Note: Other messaging functions from base.html are available through the global scope
// since they're defined in base.html and inherited by this page

// ==================== DMPO HQ DASHBOARD FUNCTIONS ====================
let qoSqiChart = null;
let qoQualityData = null;

// Load quality officer data
function loadQOQualityOfficerData() {
    const tabPane = document.getElementById('quality-dashboard');
    if (!tabPane || !tabPane.classList.contains('active')) {
        return; // Don't load if tab is not active
    }
    
    fetch('/api/dashboard-data')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                qoQualityData = data.data;
                
                // Update stats
                const myEvalsEl = document.getElementById('qo-myEvaluations');
                const avgSqiEl = document.getElementById('qo-avgSqi');
                const daysRemainingEl = document.getElementById('qo-daysRemaining');
                const todayCountEl = document.getElementById('qo-todayCount');
                const dailyProgressEl = document.getElementById('qo-dailyProgress');
                
                if (myEvalsEl) myEvalsEl.textContent = data.data.my_evaluations || 0;
                if (avgSqiEl) avgSqiEl.textContent = data.data.avg_sqi || '0.0';
                if (todayCountEl) todayCountEl.textContent = data.data.today_evaluations || 0;
                
                // Update daily progress
                if (dailyProgressEl) {
                    const progress = Math.min(100, (data.data.today_evaluations || 0) * 20);
                    dailyProgressEl.style.width = progress + '%';
                }
                
                // Calculate days remaining
                if (data.data.survey_end_date && daysRemainingEl) {
                    const endDate = new Date(data.data.survey_end_date);
                    const today = new Date();
                    const diffTime = endDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    daysRemainingEl.textContent = diffDays > 0 ? diffDays : 0;
                    
                    // Update survey status
                    updateQOSurveyStatus(data.data.survey_end_date, diffDays);
                }
                
                // Load my evaluations
                loadQOMyevaluations();
                
                // Load role interactions
                loadQORoleInteractions();
                
                // Update expected completion date in modal
                if (data.data.survey_end_date) {
                    const endDate = new Date(data.data.survey_end_date);
                    endDate.setDate(endDate.getDate() + 30); // Default 30-day extension
                    const expectedCompletionEl = document.getElementById('qoExpectedCompletion');
                    if (expectedCompletionEl) {
                        expectedCompletionEl.valueAsDate = endDate;
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error loading DMPO HQ data:', error);
        });
}

function updateQOSurveyStatus(surveyEndDate, daysRemaining) {
    const statusEl = document.getElementById('qo-surveyStatus');
    if (!statusEl) return;
    
    let statusHtml = '';
    
    if (daysRemaining > 7) {
        statusHtml = `
            <div class="alert alert-success mb-0">
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle fa-2x me-3"></i>
                    <div>
                        <h6 class="alert-heading mb-1">Survey Period Active</h6>
                        <p class="mb-0">Valid until: <strong>${surveyEndDate}</strong></p>
                        <p class="mb-0">Days remaining: <strong class="text-success">${daysRemaining}</strong></p>
                    </div>
                </div>
            </div>
            
            <div class="progress mt-2 mb-2" style="height: 10px; border-radius: 5px;">
                <div class="progress-bar bg-success" style="width: ${Math.min(100, (90 - daysRemaining) / 90 * 100)}%; border-radius: 5px;"></div>
            </div>
            <small class="text-muted">Time used: ${90 - daysRemaining} of 90 days</small>
        `;
    } else if (daysRemaining > 0) {
        statusHtml = `
            <div class="alert alert-warning mb-0">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                    <div>
                        <h6 class="alert-heading mb-1">Survey Period Expiring Soon</h6>
                        <p class="mb-0">Survey ends on: <strong>${surveyEndDate}</strong></p>
                        <p class="mb-0">Only <strong class="text-warning">${daysRemaining}</strong> days remaining</p>
                        <button class="btn btn-sm btn-warning mt-2" onclick="showQOAccessRequestModal()">
                            <i class="fas fa-clock me-1"></i> Request Extension
                        </button>
                    </div>
                </div>
            </div>
        `;
    } else {
        statusHtml = `
            <div class="alert alert-danger mb-0">
                <div class="d-flex align-items-center">
                    <i class="fas fa-times-circle fa-2x me-3"></i>
                    <div>
                        <h6 class="alert-heading mb-1">Survey Period Expired</h6>
                        <p class="mb-0">Your survey period ended on <strong>${surveyEndDate}</strong></p>
                        <p class="mb-2">You cannot conduct new evaluations until access is extended.</p>
                        <button class="btn btn-sm btn-danger" onclick="showQOAccessRequestModal()">
                            <i class="fas fa-clock-history me-1"></i> Request Access Extension
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    statusEl.innerHTML = statusHtml;
}

function loadQOMyevaluations() {
    fetch('/api/my-evaluations')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateQOEvaluationsTable(data.evaluations);
                updateQOSQIChart(data.evaluations.slice(0, 7).map(e => e.sqi_score));
            } else {
                loadQOSampleEvaluations();
            }
        })
        .catch(error => {
            console.error('Error loading evaluations:', error);
            loadQOSampleEvaluations();
        });
}

function updateQOEvaluationsTable(evaluations) {
    const tableEl = document.getElementById('qo-myEvaluationsTable');
    if (!tableEl) return;
    
    let html = '';
    
    if (evaluations.length === 0) {
        html = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    <i class="fas fa-clipboard fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No evaluations found</p>
                    <a href="{{ url_for('evaluate') }}" class="btn btn-sm btn-primary mt-2">
                        <i class="fas fa-plus me-1"></i> Start Your First Evaluation
                    </a>
                </td>
            </tr>
        `;
    } else {
        evaluations.forEach(eval => {
            const ratingClass = eval.sqi_rating === 'EXCELLENT' ? 'success' :
                              eval.sqi_rating === 'GOOD' ? 'primary' :
                              eval.sqi_rating === 'AVERAGE' ? 'warning' :
                              eval.sqi_rating === 'POOR' ? 'danger' : 'dark';
            
            const priorityBadge = eval.priority === 'EMERGENCY' ? 'danger' :
                                eval.priority === 'HIGH' ? 'warning' :
                                eval.priority === 'MEDIUM' ? 'info' : 'success';
            
            const sqiClass = eval.sqi_score >= 85 ? 'text-success' :
                            eval.sqi_score >= 70 ? 'text-primary' :
                            eval.sqi_score >= 55 ? 'text-warning' :
                            eval.sqi_score >= 40 ? 'text-danger' : 'text-dark';
            
            const date = new Date(eval.timestamp);
            const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            html += `
                <tr>
                    <td><small class="text-muted">${formattedDate}</small></td>
                    <td>${eval.vessel_name}</td>
                    <td><strong class="${sqiClass}">${eval.sqi_score}</strong></td>
                    <td><span class="badge bg-${ratingClass}">${eval.sqi_rating}</span></td>
                    <td><span class="badge bg-${priorityBadge}">${eval.priority}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewQOEvaluationDetails('${eval.request_id || eval.evaluation_id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn btn-sm btn-outline-success ms-1" onclick="editQOEvaluation('${eval.request_id || eval.evaluation_id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </td>
                </tr>
            `;
        });
    }
    
    tableEl.innerHTML = html;
}

function loadQOSampleEvaluations() {
    const evaluations = [
        { evaluation_id: 'EVAL-20240125-143021', timestamp: '2024-01-25 14:30:00', vessel_name: 'MV Ocean Carrier', sqi_score: 82.5, sqi_rating: 'EXCELLENT', priority: 'LOW' },
        { evaluation_id: 'EVAL-20240124-111521', timestamp: '2024-01-24 11:15:00', vessel_name: 'SS Sea Voyager', sqi_score: 65.2, sqi_rating: 'AVERAGE', priority: 'HIGH' },
        { evaluation_id: 'EVAL-20240123-094523', timestamp: '2024-01-23 09:45:00', vessel_name: 'MV Maritime', sqi_score: 91.3, sqi_rating: 'EXCELLENT', priority: 'LOW' }
    ];
    
    updateQOEvaluationsTable(evaluations);
    updateQOSQIChart(evaluations.map(e => e.sqi_score));
}

function updateQOSQIChart(sqiValues) {
    const canvasEl = document.getElementById('qo-sqiChart');
    if (!canvasEl) return;
    
    // Destroy existing chart
    if (qoSqiChart) {
        qoSqiChart.destroy();
    }
    
    const ctx = canvasEl.getContext('2d');
    const labels = sqiValues.map((_, index) => `Evaluation ${index + 1}`);
    
    qoSqiChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'SQI Score',
                data: sqiValues,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#28a745',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = 'SQI: ' + context.parsed.y;
                            if (context.parsed.y >= 85) label += ' (EXCELLENT)';
                            else if (context.parsed.y >= 70) label += ' (GOOD)';
                            else if (context.parsed.y >= 55) label += ' (AVERAGE)';
                            else if (context.parsed.y >= 40) label += ' (POOR)';
                            else label += ' (CRITICAL)';
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    min: 0,
                    max: 100,
                    title: {
                        display: true,
                        text: 'SQI Score',
                        font: {
                            weight: 'bold'
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '/100';
                        }
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    });
}

function loadQORoleInteractions() {
    fetch('/api/inter-role-actions')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const container = document.getElementById('qo-roleInteractions');
                const section = document.getElementById('qo-roleInteractionsSection');
                const count = document.getElementById('qo-actionCount');
                
                if (!container) return;
                
                if (data.actions.length === 0) {
                    container.innerHTML = `
                        <div class="col-12 text-center py-3">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <p class="text-muted">No pending notices</p>
                            <small class="text-muted">You're all caught up!</small>
                        </div>
                    `;
                    if (count) count.textContent = '0';
                } else {
                    if (count) count.textContent = data.actions.length;
                    
                    let html = '';
                    data.actions.forEach(action => {
                        html += `
                            <div class="col-12 mb-2">
                                <div class="alert alert-${action.badge_color}">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-${action.icon} me-3" style="font-size: 1.5rem;"></i>
                                        <div class="flex-grow-1">
                                            <h6 class="alert-heading mb-1">${action.title}</h6>
                                            <p class="mb-0 small">${action.description}</p>
                                        </div>
                                        <span class="badge bg-white text-${action.badge_color}">${action.count}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                }
            }
        })
        .catch(error => {
            console.error('Error loading role interactions:', error);
        });
}

function showQOAccessRequestModal() {
    const modal = new bootstrap.Modal(document.getElementById('qoAccessRequestModal'));
    modal.show();
}

function submitQOAccessRequest() {
    const additionalDays = document.getElementById('qoAdditionalDays').value;
    const reason = document.getElementById('qoExtensionReason').value;
    const expectedCompletion = document.getElementById('qoExpectedCompletion').value;
    
    if (!additionalDays || !reason || !expectedCompletion) {
        alert('Please fill in all required fields');
        return;
    }
    
    const data = {
        reason: reason,
        additional_days: parseInt(additionalDays),
        expected_completion: expectedCompletion
    };
    
    fetch('/api/quality-officer/request-access', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Access extension request submitted successfully!');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('qoAccessRequestModal'));
            modal.hide();
            
            // Clear form
            document.getElementById('qoAccessRequestForm').reset();
            
            // Reload data
            setTimeout(() => {
                loadQOQualityOfficerData();
            }, 1000);
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function viewQOEvaluationDetails(evaluationId) {
    fetch(`/api/evaluation-details/${evaluationId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const evaluation = data.evaluation;
                
                let html = `
                    <h6>Evaluation Details</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Evaluation ID:</strong><br>
                            <code>${evaluation.evaluation_id}</code>
                        </div>
                        <div class="col-md-6">
                            <strong>Date:</strong><br>
                            ${new Date(evaluation.timestamp).toLocaleString()}
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Vessel:</strong><br>
                            ${evaluation.vessel_name}
                        </div>
                        <div class="col-md-6">
                            <strong>Category:</strong><br>
                            ${evaluation.part_category}
                        </div>
                    </div>
                    
                    <div class="alert alert-${evaluation.sqi_rating === 'EXCELLENT' ? 'success' : evaluation.sqi_rating === 'GOOD' ? 'info' : evaluation.sqi_rating === 'AVERAGE' ? 'warning' : 'danger'}">
                        <div class="row">
                            <div class="col-md-6">
                                <h3>SQI: ${evaluation.sqi_score}/100</h3>
                                <h4>Rating: ${evaluation.sqi_rating}</h4>
                            </div>
                            <div class="col-md-6 text-center">
                                <div class="display-1 fw-bold">${evaluation.sqi_score}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                const contentEl = document.getElementById('qoEvaluationDetailsContent');
                if (contentEl) {
                    contentEl.innerHTML = html;
                    const modal = new bootstrap.Modal(document.getElementById('qoEvaluationDetailsModal'));
                    modal.show();
                }
            }
        })
        .catch(error => {
            console.error('Error loading evaluation details:', error);
            alert('Error loading evaluation details');
        });
}

function editQOEvaluation(evaluationId) {
    // Redirect to evaluate page with evaluation ID for editing
    window.location.href = `/evaluate?edit=${evaluationId}`;
}

// Load DMPO HQ data when tab is shown
document.addEventListener('DOMContentLoaded', function() {
    const qualityDashboardTab = document.getElementById('quality-dashboard-tab');
    if (qualityDashboardTab) {
        qualityDashboardTab.addEventListener('shown.bs.tab', function() {
            loadQOQualityOfficerData();
        });
    }
    
    // Load if tab is already active
    const qualityDashboardPane = document.getElementById('quality-dashboard');
    if (qualityDashboardPane && qualityDashboardPane.classList.contains('active')) {
        loadQOQualityOfficerData();
    }
});
</script>
{% endblock %}
