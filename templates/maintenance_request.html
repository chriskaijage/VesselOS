{% extends "base.html" %}

{% block title %}Request Maintenance Service{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex align-items-center">
                    <i class="fas fa-ship me-3 fa-2x"></i>
                    <div>
                        <h2 class="mb-0">Marine Maintenance Request Form</h2>
                        <p class="mb-0">Request maintenance services or parts for your vessel</p>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <form id="maintenanceRequestForm">
                    <!-- Vessel Information -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h4 class="mb-0"><i class="fas fa-anchor me-2"></i> Vessel Information</h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Ship Name *</label>
                                        <input type="text" class="form-control" name="ship_name" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">IMO Number *</label>
                                        <input type="text" class="form-control" name="imo_number" required 
                                               pattern="IMO\d{7}" title="Enter valid IMO number (e.g., IMO1234567)">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Vessel Type *</label>
                                        <select class="form-select" name="vessel_type" required>
                                            <option value="">Select Type</option>
                                            <option>Container Ship</option>
                                            <option>Tanker</option>
                                            <option>Bulk Carrier</option>
                                            <option>Passenger Ship</option>
                                            <option>Offshore Vessel</option>
                                            <option>Fishing Vessel</option>
                                            <option>Tug Boat</option>
                                            <option>Other</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Current Location *</label>
                                        <input type="text" class="form-control" name="location" required 
                                               placeholder="Port name or coordinates">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Request Details -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h4 class="mb-0"><i class="fas fa-tools me-2"></i> Service Request Details</h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Request Type *</label>
                                        <select class="form-select" name="request_type" required onchange="togglePartDetails()">
                                            <option value="">Select Type</option>
                                            <option value="maintenance">Maintenance Service</option>
                                            <option value="part">Part Replacement</option>
                                            <option value="repair">Emergency Repair</option>
                                            <option value="inspection">Technical Inspection</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Criticality Level *</label>
                                        <select class="form-select" name="criticality" required onchange="updateCriticalityUI()">
                                            <option value="">Select Criticality</option>
                                            <option value="emergency">Emergency (Vessel Immobilized)</option>
                                            <option value="urgent">Urgent (Affects Operation)</option>
                                            <option value="high">High (Needs Attention)</option>
                                            <option value="medium">Medium (Scheduled)</option>
                                            <option value="low">Low (Routine)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Part Details (shown when part replacement selected) -->
                            <div id="partDetailsSection" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Please provide part details for replacement request
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Part Category</label>
                                            <select class="form-select" name="part_category">
                                                <option value="">Select Category</option>
                                                <option>Engine Parts</option>
                                                <option>Navigation Equipment</option>
                                                <option>Safety Gear</option>
                                                <option>Electrical Components</option>
                                                <option>Hydraulic Systems</option>
                                                <option>Pump Systems</option>
                                                <option>Deck Equipment</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Part Number (if known)</label>
                                            <input type="text" class="form-control" name="part_number" 
                                                   placeholder="e.g., ENG-001-2024">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Part Name</label>
                                            <input type="text" class="form-control" name="part_name" 
                                                   placeholder="e.g., Cylinder Liner">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Quantity Required</label>
                                            <input type="number" class="form-control" name="quantity" min="1" value="1">
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label class="form-label">Manufacturer/Model</label>
                                            <input type="text" class="form-control" name="manufacturer" 
                                                   placeholder="e.g., MAN Diesel & Turbo, Model XYZ">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Detailed Description *</label>
                                <textarea class="form-control" name="description" rows="4" required 
                                          placeholder="Please describe the issue, symptoms, and any error codes..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Emergency Contact Information</label>
                                <input type="text" class="form-control" name="emergency_contact" 
                                       placeholder="24/7 contact number for emergencies">
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Estimated Time of Arrival (ETA)</label>
                                        <input type="datetime-local" class="form-control" name="eta">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Attach Supporting Documents</label>
                                        <input type="file" class="form-control" name="attachments" multiple 
                                               accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx">
                                        <small class="text-muted">Photos, diagrams, or documentation (max 100MB total)</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Requester Information -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h4 class="mb-0"><i class="fas fa-user me-2"></i> Requester Information</h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Contact Person *</label>
                                        <input type="text" class="form-control" name="requested_by_name" 
                                               value="{% if current_user.is_authenticated %}{{ current_user.get_full_name() }}{% endif %}" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Email Address *</label>
                                        <input type="email" class="form-control" name="requested_by_email" 
                                               value="{% if current_user.is_authenticated %}{{ current_user.email }}{% endif %}" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Phone Number *</label>
                                        <input type="tel" class="form-control" name="requested_by_phone" required>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Company/Organization</label>
                                <input type="text" class="form-control" name="company" 
                                       placeholder="Shipping company or organization">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Additional Notes</label>
                                <textarea class="form-control" name="notes" rows="3" 
                                          placeholder="Any additional information or special requirements..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Criticality Alert -->
                    <div class="alert alert-warning" id="criticalityAlert" style="display: none;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Emergency Request:</strong> For critical emergencies, please also contact our emergency hotline: 
                        <strong>+255694022281</strong>
                    </div>
                    
                    <!-- Submit Section -->
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg px-5 py-3">
                            <i class="fas fa-paper-plane me-2"></i> Submit Maintenance Request
                        </button>
                        <div class="mt-3">
                            <a href="{{ url_for('login') }}" class="btn btn-outline-dark btn-lg px-5 py-3">
                                <i class="fas fa-arrow-left me-2"></i> Back to Login
                            </a>
                        </div>
                        <p class="text-muted mt-3">
                            <i class="fas fa-shield-alt me-1"></i>
                            {% if current_user.is_authenticated and current_user.role == 'chief_engineer' %}
                            Your request will be sent to the Captain for approval before being submitted to the Harbour Master.
                            {% elif current_user.is_authenticated and current_user.role == 'captain' %}
                            As Captain, you can view all vessel requests. Chief Engineers should submit maintenance requests.
                            {% else %}
                            Your request will be processed immediately. Emergency requests receive priority response.
                            {% endif %}
                        </p>
                    </div>
                </form>
                
                <!-- Success Message -->
                <div class="alert alert-success mt-4" id="successMessage" style="display: none;">
                    <h4><i class="fas fa-check-circle me-2"></i> Request Submitted Successfully!</h4>
                    <p>Your maintenance request <strong id="requestIdDisplay"></strong> has been received.</p>
                    <div class="mt-3">
                        <p><strong>Next Steps:</strong></p>
                        <ol class="mb-0">
                            {% if current_user.is_authenticated and current_user.role == 'chief_engineer' %}
                            <li>Your request has been sent to the Captain for approval</li>
                            <li>Once approved by the Captain, it will be forwarded to the Harbour Master</li>
                            <li>You will receive notifications at each stage of the process</li>
                            <li>Track your request status from your dashboard</li>
                            {% else %}
                            <li>Our harbour master will review your request within 15 minutes</li>
                            <li>You will receive a confirmation email with your request details</li>
                            <li>For emergencies, we will contact you immediately via phone</li>
                            <li>Track your request status using your request ID</li>
                            {% endif %}
                        </ol>
                    </div>
                    <div class="mt-3">
                        <a href="#" class="btn btn-outline-primary" onclick="window.printRequest && window.printRequest()">
                            <i class="fas fa-print me-1"></i> Print Request Summary
                        </a>
                        <button class="btn btn-outline-success ms-2" onclick="window.newRequest && window.newRequest()">
                            <i class="fas fa-plus me-1"></i> Submit Another Request
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Information Cards -->
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-clock fa-3x text-primary mb-3"></i>
                        <h5>Response Time</h5>
                        <p class="text-muted">Emergency: Within 30 minutes<br>Standard: Within 4 hours</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-globe fa-3x text-success mb-3"></i>
                        <h5>Global Coverage</h5>
                        <p class="text-muted">Services available in 150+ ports worldwide</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-headset fa-3x text-warning mb-3"></i>
                        <h5>24/7 Support</h5>
                        <p class="text-muted">Round-the-clock technical support available</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function togglePartDetails() {
    const requestType = document.querySelector('select[name="request_type"]').value;
    const partSection = document.getElementById('partDetailsSection');
    
    if (requestType === 'part') {
        partSection.style.display = 'block';
    } else {
        partSection.style.display = 'none';
    }
}

function updateCriticalityUI() {
    const criticality = document.querySelector('select[name="criticality"]').value;
    const alert = document.getElementById('criticalityAlert');
    
    if (criticality === 'emergency') {
        alert.style.display = 'block';
        alert.className = 'alert alert-danger';
        alert.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>EMERGENCY ALERT:</strong> Your vessel is immobilized. Please IMMEDIATELY call our emergency hotline: 
            <strong class="text-danger">+255694022281</strong> and stay on the line.
            <div class="mt-2">
                <button class="btn btn-sm btn-danger" onclick="window.callEmergency && window.callEmergency()">
                    <i class="fas fa-phone me-1"></i> Call Emergency Hotline Now
                </button>
            </div>
        `;
    } else if (criticality === 'urgent') {
        alert.style.display = 'block';
        alert.className = 'alert alert-warning';
        alert.innerHTML = `
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong>Urgent Request:</strong> For urgent matters affecting vessel operation, 
            you may also contact: <strong>+255694022281</strong>
        `;
    } else {
        alert.style.display = 'none';
    }
}

function callEmergency() {
    alert('This would initiate an emergency phone call to +255694022281');
    // In a real system: window.location.href = 'tel:+18006274633';
}

function initializeMaintenanceFormListener() {
    const maintenanceForm = document.getElementById('maintenanceRequestForm');
    if (!maintenanceForm) {
        console.error('maintenanceRequestForm not found');
        return;
    }
        
        maintenanceForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            // Separate files from form data
            const attachmentFiles = formData.getAll('attachments');
        
        // Convert form data to JSON (excluding files)
        const jsonData = {};
        for (const [key, value] of formData.entries()) {
            if (key !== 'attachments') {  // Skip file inputs
                jsonData[key] = value;
            }
        }
        
        // Show loading state
        const submitBtn = document.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
        submitBtn.disabled = true;
        
        // Step 1: Submit request data
        fetch('/api/maintenance-requests', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(jsonData)
        })
        .then(response => {
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                return response.text().then(text => {
                    throw new Error('Server returned non-JSON response. Please check if you are logged in or contact support.');
                });
            }
            return response.json();
        })
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Failed to submit request');
            }
            
            const requestId = data.request_id;
            
            // Step 2: Upload attachments if any exist
            if (attachmentFiles && attachmentFiles.length > 0) {
                const uploadFormData = new FormData();
                attachmentFiles.forEach(file => {
                    uploadFormData.append('files', file);
                });
            
            return fetch(`/api/maintenance-requests/${requestId}/attachments/upload`, {
                method: 'POST',
                body: uploadFormData
            })
            .then(response => response.json())
            .then(uploadData => {
                // Return both request creation data and upload data
                return {
                    ...data,
                    attachments: uploadData.saved || []
                };
            })
            .catch(error => {
                console.warn('Warning: Attachments upload failed, but request was created', error);
                // Don't fail the whole operation if attachments fail
                return data;
            });
            }
            
            return data;
        })
        .then(data => {
            // Show success message
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('requestIdDisplay').textContent = data.request_id;
            document.getElementById('maintenanceRequestForm').reset();
            
            // Scroll to success message
            document.getElementById('successMessage').scrollIntoView({ behavior: 'smooth' });
            
            // Log to console
            console.log('Maintenance Request Submitted:', {
                request_id: data.request_id,
                data: jsonData,
                attachments: data.attachments,
                timestamp: new Date().toISOString()
            });
        })
        .catch(error => {
            console.error('Error submitting maintenance request:', error);
            alert('Error submitting request: ' + error.message);
        })
        .finally(() => {
            // Restore button
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
        });
    }
}

function printRequest() {
    // Generate printable summary
    const printContent = `
        <html>
        <head>
            <title>Maintenance Request Summary</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { color: #0056b3; }
                .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; }
                .label { font-weight: bold; color: #666; }
                .value { margin-bottom: 10px; }
            </style>
        </head>
        <body>
            <h1>Marine Maintenance Request</h1>
            <div class="section">
                <h3>Request ID: ${document.getElementById('requestIdDisplay').textContent}</h3>
                <p>Date: ${new Date().toLocaleString()}</p>
            </div>
            <div class="section">
                <h3>Vessel Information</h3>
                <p>Request submitted successfully. Details will be emailed to you.</p>
            </div>
        </body>
        </html>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
}

function newRequest() {
    document.getElementById('successMessage').style.display = 'none';
    document.getElementById('maintenanceRequestForm').reset();
    document.getElementById('criticalityAlert').style.display = 'none';
    document.getElementById('partDetailsSection').style.display = 'none';
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Initialize form listener
    initializeMaintenanceFormListener();
    
    // Set default ETA to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const etaInput = document.querySelector('input[name="eta"]');
    if (etaInput) {
        etaInput.valueAsDate = tomorrow;
    }
});
</script>
{% endblock %}