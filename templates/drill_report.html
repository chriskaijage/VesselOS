{% extends "base.html" %}

{% block title %}Drill Report - Marine Service Center{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-fire fa-2x me-3"></i>
                        <div>
                            <h2 class="mb-0">Emergency Drill Report</h2>
                            <p class="mb-0">SOLAS / ISPS Code Compliance Documentation</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Compliance Alert -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info border-2 border-info">
                <h6 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Emergency Drill Requirements</h6>
                <ul class="mb-0 small">
                    <li><strong>Minimum Frequency:</strong> Monthly drills required (fire, abandon ship, man overboard)</li>
                    <li><strong>Annual Records:</strong> Maintain documented records of all drills conducted</li>
                    <li><strong>Officer Signature:</strong> Officer in Charge must sign and date the report</li>
                    <li><strong>Master Attestation:</strong> Master reviews and approves drill performance</li>
                    <li><strong>Deficiency Tracking:</strong> Document any deficiencies and corrective actions</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-11 mx-auto">
            <form id="drillReportForm">
                <!-- SECTION 1: Vessel Information -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-ship me-2"></i> Vessel Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Vessel Name *</label>
                                <input type="text" class="form-control" name="vessel_name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">IMO Number *</label>
                                <input type="text" class="form-control" name="imo_number" placeholder="IMO1234567" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Flag State</label>
                                <input type="text" class="form-control" name="flag_state" placeholder="e.g., Panama">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Port / Position *</label>
                                <input type="text" class="form-control" name="port_position" required>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 2: Drill Details -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-calendar me-2"></i> Drill Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date *</label>
                                <input type="date" class="form-control" name="report_date" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Start Time</label>
                                <input type="time" class="form-control" name="time_start">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">End Time</label>
                                <input type="time" class="form-control" name="time_end">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Drill Type *</label>
                                <div class="drill-type-options">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input drill-type-check" type="checkbox" name="drill_types" value="Fire" id="drillFire">
                                        <label class="form-check-label" for="drillFire">☐ Fire</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input drill-type-check" type="checkbox" name="drill_types" value="Abandon Ship" id="drillAbandon">
                                        <label class="form-check-label" for="drillAbandon">☐ Abandon Ship</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input drill-type-check" type="checkbox" name="drill_types" value="Man Overboard" id="drillMOB">
                                        <label class="form-check-label" for="drillMOB">☐ Man Overboard</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input drill-type-check" type="checkbox" name="drill_types" value="Oil Spill" id="drillSpill">
                                        <label class="form-check-label" for="drillSpill">☐ Oil Spill</label>
                                    </div>
                                    <div class="form-check form-check-inline mt-2">
                                        <input class="form-check-input drill-type-check" type="checkbox" name="drill_types" value="Emergency Steering" id="drillSteering">
                                        <label class="form-check-label" for="drillSteering">☐ Emergency Steering</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input drill-type-check" type="checkbox" name="drill_types" value="Engine Room" id="drillEngine">
                                        <label class="form-check-label" for="drillEngine">☐ Engine Room</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input drill-type-check" type="checkbox" name="drill_types" value="Security" id="drillSecurity">
                                        <label class="form-check-label" for="drillSecurity">☐ Security</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <label class="form-check-label" for="drillOther">☐ Other:</label>
                                        <input class="form-check-input drill-type-check" type="checkbox" name="drill_types" value="Other" id="drillOther">
                                        <input type="text" class="form-control form-control-sm d-inline-block" style="width: 150px; margin-left: 5px;" name="other_drill_type" id="otherDrillInput">
                                    </div>
                                </div>
                                <input type="hidden" id="drillTypeHidden" name="drill_type">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 3: Weather Conditions -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-cloud me-2"></i> Weather Conditions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Wind</label>
                                <input type="text" class="form-control" name="weather_wind" placeholder="e.g., 15 knots from NW">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Sea State</label>
                                <input type="text" class="form-control" name="weather_sea_state" placeholder="e.g., Moderate (2-3m)">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Visibility</label>
                                <input type="text" class="form-control" name="weather_visibility" placeholder="e.g., 5 nautical miles">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 4: Personnel -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-users me-2"></i> Personnel Involved</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Total Crew Onboard *</label>
                                <input type="number" class="form-control" name="total_crew_onboard" min="0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Crew Participated *</label>
                                <input type="number" class="form-control" name="crew_participated" min="0" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Officer in Charge - Name *</label>
                                <input type="text" class="form-control" name="officer_name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Officer in Charge - Rank</label>
                                <input type="text" class="form-control" name="officer_rank">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 5: Drill Scenario & Actions -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-tasks me-2"></i> Drill Scenario & Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Drill Scenario Description</label>
                            <textarea class="form-control" name="drill_scenario" rows="3" placeholder="Brief description of simulated emergency"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Actions Taken</label>
                            <textarea class="form-control" name="actions_taken" rows="3" placeholder="Describe actions taken during the drill"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Equipment Used</label>
                            <div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="equipment_fire_pumps" id="equipFirePumps">
                                    <label class="form-check-label" for="equipFirePumps">☐ Fire Pumps</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="equipment_breathing_apparatus" id="equipBA">
                                    <label class="form-check-label" for="equipBA">☐ Breathing Apparatus</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="equipment_lifeboats" id="equipLifeboats">
                                    <label class="form-check-label" for="equipLifeboats">☐ Lifeboats / Liferafts</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="equipment_emergency_generator" id="equipGenerator">
                                    <label class="form-check-label" for="equipGenerator">☐ Emergency Generator</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="equipment_emergency_steering" id="equipSteering">
                                    <label class="form-check-label" for="equipSteering">☐ Emergency Steering</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="equipment_spill_response" id="equipSpill">
                                    <label class="form-check-label" for="equipSpill">☐ Spill Response Equipment</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 6: Performance Evaluation -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-star me-2"></i> Performance Evaluation</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Overall Performance Rating *</label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="performance_rating" value="Excellent" id="perfExcellent" required>
                                    <label class="form-check-label" for="perfExcellent">☐ Excellent</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="performance_rating" value="Satisfactory" id="perfSatisfactory">
                                    <label class="form-check-label" for="perfSatisfactory">☐ Satisfactory</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="performance_rating" value="Needs Improvement" id="perfNeeds">
                                    <label class="form-check-label" for="perfNeeds">☐ Needs Improvement</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observed Deficiencies</label>
                            <textarea class="form-control" name="deficiencies_observed" rows="3" placeholder="List any deficiencies identified"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Corrective Actions Required</label>
                            <textarea class="form-control" name="corrective_actions" rows="3" placeholder="Describe required corrective actions"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Target Completion Date</label>
                            <input type="date" class="form-control" name="target_completion_date">
                        </div>
                    </div>
                </div>

                <!-- SECTION 13: Master Remarks & Signatures -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-pen fa-sm me-2"></i> Master Remarks & Signatures</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">SSO Remarks</label>
                            <textarea class="form-control" name="sso_remarks" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Master / Chief Engineer Remarks</label>
                            <textarea class="form-control" name="master_remarks" rows="4" placeholder="Additional remarks from Master or Chief Engineer"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Officer Signature</label>
                            <div id="signaturePad" class="border" style="height: 150px; background: #f5f5f5; cursor: crosshair;"></div>
                            <small class="form-text text-muted">Draw your signature in the box above</small>
                            <button type="button" class="btn btn-sm btn-secondary me-2" onclick="clearSignature()">Clear Signature</button>
                            <input type="hidden" name="signature_data" id="signatureData">
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="row mb-4">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            <i class="fas fa-paper-plane me-2"></i> Submit Drill Report
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Signature Pad Script -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

<style>
    .drill-type-options {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }
</style>

<script>
    let signaturePad;

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize signature pad
        const canvas = document.getElementById('signaturePad');
        if (canvas) {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            signaturePad = new SignaturePad(canvas);
        }

        // Handle drill type checkboxes
        document.querySelectorAll('.drill-type-check').forEach(checkbox => {
            checkbox.addEventListener('change', updateDrillType);
        });

        // Form submission
        document.getElementById('drillReportForm').addEventListener('submit', submitDrillReport);
    });

    function updateDrillType() {
        // Show/hide specific drill sections
        const selected = Array.from(document.querySelectorAll('.drill-type-check:checked'))
            .map(cb => cb.value)
            .join(', ');
        document.getElementById('drillTypeHidden').value = selected;
    }

    function clearSignature() {
        if (signaturePad) signaturePad.clear();
    }

    async function submitDrillReport(e) {
        e.preventDefault();

        // Collect form data
        const formData = new FormData(document.getElementById('drillReportForm'));
        const data = Object.fromEntries(formData);

        // Add signature
        if (signaturePad && !signaturePad.isEmpty()) {
            data.signature_data = signaturePad.toDataURL();
        }

        // Collect equipment used
        const equipmentUsed = [];
        if (document.querySelector('input[name="equipment_fire_pumps"]:checked')) equipmentUsed.push('Fire Pumps');
        if (document.querySelector('input[name="equipment_breathing_apparatus"]:checked')) equipmentUsed.push('Breathing Apparatus');
        if (document.querySelector('input[name="equipment_lifeboats"]:checked')) equipmentUsed.push('Lifeboats/Liferafts');
        if (document.querySelector('input[name="equipment_emergency_generator"]:checked')) equipmentUsed.push('Emergency Generator');
        if (document.querySelector('input[name="equipment_emergency_steering"]:checked')) equipmentUsed.push('Emergency Steering');
        if (document.querySelector('input[name="equipment_spill_response"]:checked')) equipmentUsed.push('Spill Response Equipment');
        data.equipment_used = equipmentUsed.join(', ');

        try {
            const response = await fetch('/api/drill-report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (result.success) {
                alert('Drill report submitted successfully!\nReport ID: ' + result.report_id);
                document.getElementById('drillReportForm').reset();
                clearSignature();
                setTimeout(() => window.location.href = '/drill-reports', 1500);
            } else {
                alert('Error: ' + result.error);
            }
        } catch (error) {
            alert('Error submitting report: ' + error.message);
        }
    }
</script>
{% endblock %}
