{% extends "base.html" %}

{% block title %}Harbour Master Dashboard - Marine Service Center{% endblock %}

{% block content %}
{% if current_user_profile.profile_pic_url %}
<div class="text-center mb-4">
    <img src="{{ current_user_profile.profile_pic_url }}" 
         class="rounded-circle shadow" 
         style="width: 120px; height: 120px; object-fit: cover; border: 4px solid #007bff;"
         alt="Profile Picture">
    <h4 class="mt-3">{{ current_user_profile.full_name }}</h4>
    <p class="text-muted">{{ current_user_profile.rank }} • {{ current_user_profile.role|replace('_', ' ')|title }}</p>
</div>
{% endif %}

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas fa-tools fa-3x" style="color: #ff9800;"></i>
                    </div>
                    <div>
                        <h1 class="mb-1">Harbour Master Dashboard</h1>
                        <p class="lead mb-0">Manage service requests, inventory, and maintenance operations</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Harbour Master Stats -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card metric-card border-start border-5 border-primary">
            <div class="card-body text-center">
                <div class="metric-value" id="totalRequests">--</div>
                <div class="metric-label">Total Requests</div>
                <small class="text-muted">All service requests</small>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card metric-card border-start border-5 border-success">
            <div class="card-body text-center">
                <div class="metric-value" id="activeRequests">--</div>
                <div class="metric-label">Active Requests</div>
                <small class="text-muted">Currently being serviced</small>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card metric-card border-start border-5 border-info">
            <div class="card-body text-center">
                <div class="metric-value" id="avgResponse">--</div>
                <div class="metric-label">Avg Response</div>
                <small class="text-muted">Response time (hours)</small>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card metric-card border-start border-5 border-warning">
            <div class="card-body text-center">
                <div class="metric-value" id="lowStock">--</div>
                <div class="metric-label">Low Stock</div>
                <small class="text-muted">Items need reordering</small>
            </div>
        </div>
    </div>
</div>

<!-- Role Interactions -->
<div class="row mb-4" id="roleInteractionsSection">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i> Actions Requiring Attention</h5>
                    <span class="badge bg-danger" id="actionCount">0</span>
                </div>
            </div>
            <div class="card-body">
                <div class="row" id="roleInteractions">
                    <div class="col-12 text-center py-3">
                        <div class="spinner-border text-warning" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Checking for actions...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Left Column -->
    <div class="col-lg-4">
        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row g-2 mb-3">
                    <div class="col-12 col-sm-6">
                        <a href="{{ url_for('evaluate') }}" class="btn btn-primary w-100 d-flex align-items-center justify-content-center py-2">
                            <i class="fas fa-plus-circle me-2"></i>
                            <span>New Service Evaluation</span>
                        </a>
                    </div>
                    <div class="col-12 col-sm-6">
                        <a href="{{ url_for('inventory') }}" class="btn btn-warning w-100 d-flex align-items-center justify-content-center py-2">
                            <i class="fas fa-boxes me-2"></i>
                            <span>Check Inventory</span>
                        </a>
                    </div>
                    <div class="col-12 col-sm-6">
                        <a href="/emergency-requests" class="btn btn-danger w-100 d-flex align-items-center justify-content-center py-2">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span>Emergency Requests</span>
                        </a>
                    </div>
                    <div class="col-12 col-sm-6">
                        <a href="{{ url_for('profile') }}" class="btn btn-success w-100 d-flex align-items-center justify-content-center py-2">
                            <i class="fas fa-user-circle me-2"></i>
                            <span>My Profile</span>
                        </a>
                    </div>
                </div>
                <hr class="my-3">
                <!-- Emergency Actions -->
                <div class="mt-3">
                    <h6 class="text-danger mb-2"><i class="fas fa-exclamation-octagon me-2"></i> Emergency Actions</h6>
                    <div class="row g-2">
                        <div class="col-12">
                            <button type="button" class="btn btn-outline-danger w-100 d-flex align-items-center justify-content-center py-2" onclick="handleEmergency()">
                                <i class="fas fa-phone-alt me-2"></i> Call Emergency Support
                            </button>
                        </div>
                        <div class="col-12">
                            <button type="button" class="btn btn-outline-warning w-100 d-flex align-items-center justify-content-center py-2" onclick="requestManagerApproval()">
                                <i class="fas fa-shield-check me-2"></i> Request Port Engineer Approval
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Inventory Status -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-boxes me-2"></i> Inventory Status</h5>
            </div>
            <div class="card-body">
                <div id="inventoryStatus">
                    <div class="text-center py-2">
                        <div class="spinner-border spinner-border-sm text-warning" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <small class="text-muted ms-2">Loading inventory status...</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Assigned Requests -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i> My Assigned Requests</h5>
            </div>
            <div class="card-body">
                <div id="assignedRequests">
                    <div class="text-center py-2">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <small class="text-muted ms-2">Loading assigned requests...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Right Column -->
    <div class="col-lg-8">
        <!-- Recent Service Requests -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list-alt me-2"></i> Recent Service Requests</h5>
                    <div>
                        <a href="/maintenance-request" class="btn btn-sm btn-primary">
                            <i class="fas fa-plus me-1"></i> New Request
                        </a>
                        <button class="btn btn-sm btn-outline-secondary" onclick="loadServiceRequests()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Request ID</th>
                                <th>Vessel</th>
                                <th>Type</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="serviceRequests">
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Loading service requests...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Emergency Requests -->
        <div class="card mt-3 border-danger" id="emergencySection" style="display: none;">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-exclamation-octagon me-2"></i> Emergency Service Requests</h5>
            </div>
            <div class="card-body">
                <div id="emergencyRequests">
                    <!-- Emergency requests will appear here -->
                </div>
            </div>
        </div>
        
        <!-- Performance Summary -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i> Performance Summary</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 col-md-3 mb-3">
                        <div class="p-2 bg-light rounded">
                            <div class="h5 mb-1 text-success" id="perfCompletion">--%</div>
                            <small class="text-muted">Completion Rate</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <div class="p-2 bg-light rounded">
                            <div class="h5 mb-1 text-info" id="perfTime">--h</div>
                            <small class="text-muted">Avg Service Time</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <div class="p-2 bg-light rounded">
                            <div class="h5 mb-1 text-warning" id="perfCost">$--</div>
                            <small class="text-muted">Avg Service Cost</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <div class="p-2 bg-light rounded">
                            <div class="h5 mb-1 text-primary" id="perfSatisfaction">--%</div>
                            <small class="text-muted">Satisfaction Rate</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Evaluations -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-clipboard-check me-2"></i> Recent Service Evaluations</h5>
            </div>
            <div class="card-body">
                <div id="recentEvaluations">
                    <div class="text-center py-2">
                        <div class="spinner-border spinner-border-sm text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <small class="text-muted ms-2">Loading recent evaluations...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Request Details Modal -->
<div class="modal fade" id="requestDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Request Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="requestDetailsContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Reorder Request Modal -->
<div class="modal fade" id="reorderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Request Port Engineer Approval</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reorderForm">
                    <div class="mb-3">
                        <label class="form-label">Part Number *</label>
                        <input type="text" class="form-control" id="reorderPartNumber" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Part Name *</label>
                        <input type="text" class="form-control" id="reorderPartName" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Current Stock *</label>
                                <input type="number" class="form-control" id="reorderCurrentStock" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Reorder Quantity *</label>
                                <input type="number" class="form-control" id="reorderQuantity" min="1" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Reason for Reorder *</label>
                        <textarea class="form-control" id="reorderReason" rows="3" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Urgency Level *</label>
                        <select class="form-select" id="reorderUrgency" required>
                            <option value="">Select Urgency</option>
                            <option value="critical">Critical (Immediate)</option>
                            <option value="high">High (Within 24h)</option>
                            <option value="medium">Medium (Within 72h)</option>
                            <option value="low">Low (Within 1 week)</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitReorderRequest()">Submit Request</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let maintenanceData = null;

// Load harbour master data
function loadMaintenanceData() {
    // Load all data in parallel instead of sequentially for better performance
    Promise.all([
        fetch('/api/dashboard-data').then(r => r.json()),
        fetch('/api/emergency-requests').then(r => r.json()),
        fetch('/api/maintenance-requests').then(r => r.json()),
        fetch('/api/role-interactions').then(r => r.json()).catch(() => ({success: false})),
        fetch('/api/inventory-status').then(r => r.json()).catch(() => ({success: false})),
        fetch('/api/assigned-requests').then(r => r.json()).catch(() => ({success: false})),
        fetch('/api/recent-evaluations').then(r => r.json()).catch(() => ({success: false}))
    ])
    .then(([dashData, emergencyData, serviceData, roleData, invData, assignData, evalData]) => {
        // Update dashboard stats
        if (dashData.success) {
            document.getElementById('totalRequests').textContent = dashData.total_requests || 0;
            document.getElementById('activeRequests').textContent = dashData.active_ships || 0;
            document.getElementById('avgResponse').textContent = (dashData.avg_response || 0).toFixed(1) + 'h';
            document.getElementById('lowStock').textContent = dashData.low_stock || 0;
            
            // Update performance summary
            document.getElementById('perfCompletion').textContent = dashData.satisfaction + '%';
            document.getElementById('perfTime').textContent = (dashData.avg_response || 0).toFixed(1) + 'h';
            document.getElementById('perfSatisfaction').textContent = dashData.satisfaction + '%';
        }
        
        // Update emergency section
        if (emergencyData.success && emergencyData.data && emergencyData.data.length > 0) {
            document.getElementById('emergencySection').style.display = 'block';
            updateEmergencyRequests(emergencyData.data);
        } else {
            document.getElementById('emergencySection').style.display = 'none';
        }
        
        // Update service requests
        if (serviceData.success && serviceData.requests) {
            updateServiceRequestsTable(serviceData.requests);
        }
        
        // Update role interactions (if available)
        if (roleData.success && roleData.interactions) {
            updateRoleInteractions(roleData.interactions);
        }
        
        // Update inventory status (if available)
        if (invData.success && invData.inventory) {
            updateInventoryStatus(invData.inventory);
        }
        
        // Update assigned requests (if available)
        if (assignData.success && assignData.requests) {
            updateAssignedRequests(assignData.requests);
        }
        
        // Update evaluations (if available)
        if (evalData.success && evalData.evaluations) {
            updateRecentEvaluations(evalData.evaluations);
        }
    })
    .catch(error => {
        console.error('Error loading dashboard data:', error);
        // Show user-friendly error message
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-warning alert-dismissible fade show';
        alertDiv.innerHTML = `
            <strong>Loading Data...</strong> Some dashboard elements are loading. Please wait.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        const container = document.querySelector('.dashboard-content') || document.body;
        container.insertBefore(alertDiv, container.firstChild);
    });
}

function updateServiceRequestsTable(requests) {
    let html = '';
    
    if (requests.length === 0) {
        html = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    <i class="fas fa-clipboard fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No service requests found</p>
                    <a href="/maintenance-request" class="btn btn-sm btn-primary mt-2">
                        <i class="fas fa-plus me-1"></i> Create New Request
                    </a>
                </td>
            </tr>
        `;
    } else {
        requests.slice(0, 10).forEach(req => {
            const priorityBadge = req.priority === 'EMERGENCY' ? 'danger' :
                                req.priority === 'HIGH' ? 'warning' :
                                req.priority === 'MEDIUM' ? 'info' : 'success';
            
            const statusBadge = req.status === 'completed' ? 'success' :
                              req.status === 'in_progress' ? 'primary' :
                              req.status === 'assigned' ? 'warning' : 'secondary';
            
            const statusText = req.status === 'completed' ? 'Completed' :
                             req.status === 'in_progress' ? 'In Progress' :
                             req.status === 'assigned' ? 'Assigned' : 'Pending';
            
            html += `
                <tr>
                    <td><small class="text-muted">${req.request_id}</small></td>
                    <td>${req.ship_name}</td>
                    <td>${req.request_type}</td>
                    <td><span class="badge bg-${priorityBadge}">${req.priority}</span></td>
                    <td><span class="badge bg-${statusBadge}">${statusText}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewRequestDetails('${req.request_id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success ms-1" onclick="updateRequestStatus('${req.request_id}')">
                            <i class="fas fa-check-circle"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    }
    
    document.getElementById('serviceRequests').innerHTML = html;
}

function loadSampleServiceRequests() {
    const requests = [
        { request_id: 'MR-20240125-143021', ship_name: 'MV Ocean Carrier', request_type: 'Maintenance', priority: 'LOW', status: 'completed' },
        { request_id: 'MR-20240124-111521', ship_name: 'SS Sea Voyager', request_type: 'Part Replacement', priority: 'HIGH', status: 'in_progress' },
        { request_id: 'MR-20240123-094523', ship_name: 'MV Coastal', request_type: 'Inspection', priority: 'LOW', status: 'completed' },
        { request_id: 'MR-20240122-162312', ship_name: 'MV Coastal', request_type: 'Emergency Repair', priority: 'EMERGENCY', status: 'assigned' },
        { request_id: 'MR-20240121-093421', ship_name: 'MV Horizon', request_type: 'Maintenance', priority: 'MEDIUM', status: 'in_progress' }
    ];
    
    let html = '';
    requests.forEach(req => {
        const priorityBadge = req.priority === 'EMERGENCY' ? 'danger' :
                            req.priority === 'HIGH' ? 'warning' :
                            req.priority === 'MEDIUM' ? 'info' : 'success';
        
        const statusBadge = req.status === 'completed' ? 'success' :
                          req.status === 'in_progress' ? 'primary' :
                          req.status === 'assigned' ? 'warning' : 'secondary';
        
        const statusText = req.status === 'completed' ? 'Completed' :
                         req.status === 'in_progress' ? 'In Progress' :
                         req.status === 'assigned' ? 'Assigned' : 'Pending';
        
        html += `
            <tr>
                <td><small class="text-muted">${req.request_id}</small></td>
                <td>${req.ship_name}</td>
                <td>${req.request_type}</td>
                <td><span class="badge bg-${priorityBadge}">${req.priority}</span></td>
                <td><span class="badge bg-${statusBadge}">${statusText}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewRequestDetails('${req.request_id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success ms-1" onclick="updateRequestStatus('${req.request_id}')">
                        <i class="fas fa-check-circle"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    document.getElementById('serviceRequests').innerHTML = html;
}

function loadEmergencyRequests() {
    // Sample emergency requests
    const emergencies = [
        { request_id: 'MR-20240122-162312', ship_name: 'MV Coastal', criticality: 'Emergency', time: '4.5 hours ago', issue: 'Hydraulic system failure' },
        { request_id: 'MR-20240120-084512', ship_name: 'SS Atlantic', criticality: 'Emergency', time: '2 days ago', issue: 'Engine overheating' }
    ];
    
    let html = '';
    emergencies.forEach(emergency => {
        html += `
            <div class="alert alert-danger">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="alert-heading">${emergency.ship_name}</h6>
                        <p class="mb-1">${emergency.issue}</p>
                        <small class="text-white-50">
function updateEmergencyRequests(emergencies) {
    let html = '';
    emergencies.forEach(emergency => {
        html += `
            <div class="emergency-alert mb-2 p-3 border-start border-danger bg-light">
                <div class="row align-items-center">
                    <div class="col">
                        <h6 class="mb-1">${emergency.title || emergency.request_type}</h6>
                        <p class="text-muted mb-2 small">${emergency.description || emergency.ship_name}</p>
                        <small class="text-danger">
                            <i class="fas fa-clock me-1"></i> ${emergency.time || new Date(emergency.created_at).toLocaleString()}
                        </small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-light" onclick="handleEmergencyRequest('${emergency.request_id}')">
                            <i class="fas fa-play-circle me-1"></i> Take Action
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('emergencyRequests').innerHTML = html;
}

function loadEmergencyRequests() {
    fetch('/api/emergency-requests')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data) {
                updateEmergencyRequests(data.data);
            }
        })
        .catch(error => console.error('Error loading emergency requests:', error));
}

function updateRoleInteractions(actions) {
    const container = document.getElementById('roleInteractions');
    const section = document.getElementById('roleInteractionsSection');
    const count = document.getElementById('actionCount');
    
    if (!actions || actions.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-3">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <p class="text-muted">No pending actions</p>
                <small class="text-muted">All systems operational</small>
            </div>
        `;
        count.textContent = '0';
    } else {
        count.textContent = actions.length;
        
        let html = '';
        actions.forEach(action => {
            html += `
                <div class="col-12 mb-2">
                    <div class="alert alert-${action.badge_color} d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-${action.icon} me-2"></i>
                            <strong>${action.title}</strong>
                            <p class="mb-0 small">${action.description}</p>
                        </div>
                        <div>
                            <span class="badge bg-white text-${action.badge_color} me-2">${action.count}</span>
                            <a href="${action.action_url}" class="btn btn-sm btn-outline-${action.badge_color === 'danger' ? 'light' : action.badge_color}">
                                View
                            </a>
                        </div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }
}

function updateInventoryStatus(inventory) {
    const lowStockItems = (inventory || []).filter(item => item.status === 'LOW' || item.status === 'CRITICAL');
    let html = '';
    
    if (lowStockItems.length === 0) {
        html = `
            <div class="text-center py-2">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <p class="text-muted">All inventory items are stocked</p>
            </div>
        `;
    } else {
        html = '<div class="list-group">';
        lowStockItems.slice(0, 5).forEach(item => {
            const criticality = item.status === 'CRITICAL' ? 'danger' : 'warning';
            
            html += `
                <div class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${item.part_name}</h6>
                        <small class="text-${criticality}">${item.status}</small>
                    </div>
                    <p class="mb-1 small">${item.part_number} • Stock: ${item.current_stock}/${item.minimum_stock}</p>
                    <button class="btn btn-sm btn-outline-warning mt-1" 
                            onclick="showReorderModal('${item.part_number}', '${item.part_name}', ${item.current_stock})">
                        <i class="fas fa-shopping-cart me-1"></i> Reorder
                    </button>
                </div>
            `;
        });
        
        if (lowStockItems.length > 5) {
            html += `
                <a href="/inventory" class="list-group-item list-group-item-action text-center text-primary">
                    View all ${lowStockItems.length} items <i class="fas fa-arrow-right"></i>
                </a>
            `;
        }
        html += '</div>';
    }
    
    document.getElementById('inventoryStatus').innerHTML = html;
}

function loadInventoryStatus() {
    fetch('/api/inventory')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateInventoryStatus(data.inventory);
            }
        })
        .catch(error => console.error('Error loading inventory:', error));
}

function updateAssignedRequests(requests) {
    let html = '<div class="list-group">';
    (requests || []).forEach(req => {
        const deadlineClass = req.deadline === 'ASAP' ? 'danger' : req.deadline.includes('Today') ? 'warning' : 'info';
        
        html += `
            <div class="list-group-item">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${req.ship_name}</h6>
                    <small class="text-${deadlineClass}">${req.deadline || 'TBD'}</small>
                </div>
                <p class="mb-1 small">${req.request_type || req.type}</p>
                <button class="btn btn-sm btn-outline-primary mt-1" onclick="viewRequestDetails('${req.request_id}')">
                    <i class="fas fa-eye me-1"></i> View Details
                </button>
            </div>
        `;
    });
    html += '</div>';
    
    document.getElementById('assignedRequests').innerHTML = html;
}

function loadAssignedRequests() {
    // Sample assigned requests - fallback if API doesn't exist
    const assigned = [
        { request_id: 'MR-20240124-111521', ship_name: 'SS Sea Voyager', type: 'Part Replacement', deadline: 'Today, 5 PM' },
        { request_id: 'MR-20240122-162312', ship_name: 'MV Coastal', type: 'Emergency Repair', deadline: 'ASAP' },
        { request_id: 'MR-20240121-093421', ship_name: 'MV Horizon', type: 'Maintenance', deadline: 'Tomorrow, 10 AM' }
    ];
    updateAssignedRequests(assigned);
}

function updateRecentEvaluations(evaluations) {
    let html = '<div class="row">';
    (evaluations || []).forEach(eval => {
        const ratingClass = eval.rating === 'Excellent' ? 'success' : eval.rating === 'Good' ? 'primary' : 'warning';
        
        html += `
            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="h3 mb-2 text-${ratingClass}">${eval.sqi || eval.score || 0}</div>
                        <h6>${eval.vessel || eval.ship_name}</h6>
                        <span class="badge bg-${ratingClass}">${eval.rating || 'N/A'}</span>
                        <p class="small text-muted mt-2">${eval.date || 'Today'}</p>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    document.getElementById('recentEvaluations').innerHTML = html;
}

function loadRecentEvaluations() {
    // Sample evaluations - fallback if API doesn't exist
    const evaluations = [
        { evaluation_id: 'EVAL-001', vessel: 'MV Ocean Carrier', sqi: 82.5, rating: 'Excellent', date: 'Today' },
        { evaluation_id: 'EVAL-002', vessel: 'SS Sea Voyager', sqi: 65.2, rating: 'Average', date: 'Yesterday' },
        { evaluation_id: 'EVAL-003', vessel: 'MV Coastal', sqi: 91.3, rating: 'Excellent', date: '2 days ago' }
    ];
    updateRecentEvaluations(evaluations);
}



function showReorderModal(partNumber, partName, currentStock) {
    document.getElementById('reorderPartNumber').value = partNumber;
    document.getElementById('reorderPartName').value = partName;
    document.getElementById('reorderCurrentStock').value = currentStock;
    document.getElementById('reorderQuantity').value = Math.max(10, currentStock * 2);
    document.getElementById('reorderReason').value = `Low stock: ${currentStock} units remaining`;
    document.getElementById('reorderUrgency').value = currentStock <= 0 ? 'critical' : 'high';
    
    const modal = new bootstrap.Modal(document.getElementById('reorderModal'));
    modal.show();
}

function submitReorderRequest() {
    const partNumber = document.getElementById('reorderPartNumber').value;
    const quantity = document.getElementById('reorderQuantity').value;
    const reason = document.getElementById('reorderReason').value;
    const urgency = document.getElementById('reorderUrgency').value;
    
    const data = {
        part_number: partNumber,
        quantity: parseInt(quantity),
        reason: reason,
        urgency: urgency
    };
    
    fetch('/api/maintenance/require-manager-approval', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Reorder request submitted to port engineer for approval.');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('reorderModal'));
            modal.hide();
            
            // Clear form
            document.getElementById('reorderForm').reset();
            
            // Reload data
            setTimeout(() => {
                loadMaintenanceData();
            }, 1000);
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function handleEmergency() {
    alert('Emergency support team has been notified. They will contact you shortly.');
}

function requestManagerApproval() {
    showReorderModal('', '', 0);
}

function viewRequestDetails(requestId) {
    fetch(`/api/request-details/${requestId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const request = data.request;
                
                let html = `
                    <h6>Request Details</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Request ID:</strong><br>
                            <code>${request.request_id}</code>
                        </div>
                        <div class="col-md-6">
                            <strong>Status:</strong><br>
                            <span class="badge bg-${request.status === 'completed' ? 'success' : request.status === 'in_progress' ? 'primary' : 'warning'}">
                                ${request.status}
                            </span>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Vessel:</strong><br>
                            ${request.ship_name}
                        </div>
                        <div class="col-md-6">
                            <strong>Type:</strong><br>
                            ${request.request_type}
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Priority:</strong><br>
                            <span class="badge bg-${request.priority === 'EMERGENCY' ? 'danger' : request.priority === 'HIGH' ? 'warning' : 'info'}">
                                ${request.priority}
                            </span>
                        </div>
                        <div class="col-md-6">
                            <strong>Location:</strong><br>
                            ${request.location}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Description:</strong><br>
                        <p>${request.description}</p>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Requested By:</strong><br>
                        ${request.requested_by_name} (${request.requested_by_email})
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-primary" onclick="updateRequestStatus('${request.request_id}')">
                            <i class="fas fa-edit me-2"></i> Update Status
                        </button>
                        <button class="btn btn-success ms-2" onclick="assignToMe('${request.request_id}')">
                            <i class="fas fa-user-check me-2"></i> Assign to Me
                        </button>
                    </div>
                `;
                
                document.getElementById('requestDetailsContent').innerHTML = html;
                const modal = new bootstrap.Modal(document.getElementById('requestDetailsModal'));
                modal.show();
            }
        });
}

function handleEmergencyRequest(requestId) {
    viewRequestDetails(requestId);
}

function updateRequestStatus(requestId) {
    const newStatus = prompt('Enter new status (pending/in_progress/completed):', 'in_progress');
    if (newStatus && ['pending', 'in_progress', 'completed'].includes(newStatus)) {
        fetch(`/api/update-request-status/${requestId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({status: newStatus})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Status updated to ${newStatus}`);
                loadMaintenanceData();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        });
    }
}

function assignToMe(requestId) {
    if (confirm('Assign this request to yourself?')) {
        fetch(`/api/assign-request/${requestId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Request assigned to you successfully!');
                loadMaintenanceData();
                bootstrap.Modal.getInstance(document.getElementById('requestDetailsModal')).hide();
            }
        });
    }
}

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadMaintenanceData();
    
    // Auto-refresh every 30 seconds
    setInterval(loadMaintenanceData, 30000);
});
</script>
{% endblock %}